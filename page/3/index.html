<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/source/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/source/favicon/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/source/favicon/favicon-16x16-next.png">
  <link rel="mask-icon" href="/source/favicon/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.fwbo.me","root":"/","scheme":"Gemini","version":"8.0.0-rc.2","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="细数星辰">
<meta property="og:url" content="http://blog.fwbo.me/page/3/index.html">
<meta property="og:site_name" content="细数星辰">
<meta property="article:author" content="fandro">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.fwbo.me/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>细数星辰</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?47b947bf10473c2a2b8bacfeff762d0a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">细数星辰</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/16/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/36-%E8%81%9A%E5%90%88-Doc%20Values%20and%20Fielddata/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/16/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/36-%E8%81%9A%E5%90%88-Doc%20Values%20and%20Fielddata/" class="post-title-link" itemprop="url">36-聚合-Doc Values and Fielddata</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-16 09:52:57" itemprop="dateCreated datePublished" datetime="2020-03-16T09:52:57+08:00">2020-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:54:42" itemprop="dateModified" datetime="2020-05-26T13:54:42+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>8.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/docvalues-and-fielddata.html" target="_blank" rel="noopener">中文参考</a>，<a href="https://github.com/elastic/elasticsearch-definitive-guide/blob/master/300_Aggregations/90_docvalues.asciidoc" target="_blank" rel="noopener">英文参考</a></p>
<h3 id="Doc-Values"><a href="#Doc-Values" class="headerlink" title="Doc Values"></a>Doc Values</h3><ul>
<li>Doc Values数据结构可以使用聚合更快、更高效并且内存友好。</li>
<li>倒排索引的优势是通过某个项(term)找文档，而相反操作并不高效，即：确定哪些项是否存在单个文档里，聚合需要这种次级的访问模式。</li>
<li>搜索使用倒排索引查找文档，聚合操作使用doc values数据进行收集和聚合。</li>
<li>Doc values 使用场景：1. 聚合 2. 排序 3. 访问字段值的脚本 4. 处理父子关系，任何需要查找某个文档包含的值的操作都必须使用它。</li>
</ul>
<p>倒排索引：<br>|Term   | Doc_1| Doc_2 | Doc_3|<br>| :—  |:—  | :—  |:—  |<br>|brown   |   X   |   X   | |<br>|dog     |   X   |       |   X|<br>|dogs    |       |   X   |   X|<br>|fox     |   X   |       |   X|<br>|foxes   |       |   X   |    |<br>|in      |       |   X   |    |<br>|jumped  |   X   |       |   X|<br>|lazy    |   X   |   X   |    |<br>|leap    |       |   X   |    |<br>|over    |   X   |   X   |   X|<br>|quick   |   X   |   X   |   X|<br>|summer  |       |   X   |    |<br>|the     |   X   |       |   X|</p>
<p>doc values 结构：<br>| doc | terms    |<br>| :— | :————- |<br>|Doc_1 | brown, dog, fox, jumped, lazy, over, quick, the      |<br>|Doc_2 | brown, dogs, foxes, in, lazy, leap, over, quick, summer  |<br>|Doc_3 | dog, dogs, fox, jumped, over, quick, the  |</p>
<p>查询语句：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span> : &#123;</span><br><span class="line">    <span class="attr">"match"</span> : &#123;</span><br><span class="line">      <span class="attr">"body"</span> : <span class="string">"brown"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggs"</span> : &#123;</span><br><span class="line">    <span class="attr">"popular_terms"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span> : &#123;</span><br><span class="line">        <span class="attr">"field"</span> : <span class="string">"body"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>步骤：</p>
<ol>
<li>查询部分：查询时在倒排索引的词项列表(已排序)中查找brown，找到brown后扫描所有列，找到包含brown的文档(Doc_1,Doc_2)。</li>
<li>聚合部分：利用doc Values数据结构，找到Doc_1,Doc_2，然后获取对应文档行，获取文档行中所有的词项，求两个集合的并集。</li>
</ol>
<h3 id="深入理解-Doc-Values"><a href="#深入理解-Doc-Values" class="headerlink" title="深入理解 Doc Values"></a>深入理解 Doc Values</h3><ul>
<li>Doc Values与倒排索引一样，是在索引时生成。</li>
<li>Doc Values与倒排索引一样，基于segement生成并且是不可变的。</li>
<li>Doc Values与倒排索引一样，会序列化到磁盘，对性能和扩展性很有帮助。</li>
<li>Doc Values通过序列化把数据持久到磁盘，它的好处是可以充分利用操作系统的内存，而不是JVM的heap。当Doc Valus很小时系统自动将它驻留内存，当Doc Valus 大于系统可用内存时，系统会根据需求从磁盘读取Doc Valus，然后选择性放到分页缓存中。</li>
<li>因为 Doc Values 不是由 JVM 来管理，所以 Elasticsearch 实例可以配置一个很小的 JVM Heap，这样给系统留出来更多的内存。同时更小的 Heap 可以让 JVM 更加快速和高效的回收。</li>
</ul>
<h5 id="列式存储的压缩-Column-store-compression"><a href="#列式存储的压缩-Column-store-compression" class="headerlink" title="列式存储的压缩(Column-store compression)"></a>列式存储的压缩(Column-store compression)</h5><ul>
<li>Doc Values本质上是一个序列化的列式存储。列式存储适用于 聚合、排序、脚本等操作。</li>
<li>列式存储也便于压缩，特别是数字类型。压缩后好处：减少磁盘空间，提高访问速度。</li>
</ul>
<p>Doc Values 在压缩过程中使用如下技巧。依次检测以下压缩模式:</p>
<ol>
<li>如果所有的数值各不相同（或缺失），设置一个标记并记录这些值</li>
<li>如果这些值小于 256，将使用一个简单的编码表</li>
<li>如果这些值大于 256，检测是否存在一个最大公约数</li>
<li>如果没有存在最大公约数，从最小的数值开始，统一计算偏移量进行编码</li>
</ol>
<h5 id="禁用Doc-Values"><a href="#禁用Doc-Values" class="headerlink" title="禁用Doc Values"></a>禁用Doc Values</h5><ul>
<li>Doc Values 默认对所有字段启用(除了 analyzed strings)。analyzed strings使用fielddata。</li>
<li>对不需要聚合、排序和脚本操作的字段禁用Doc Values，可以节省磁盘空间，提升索引的速度</li>
</ul>
<p>使用doc_values :false禁用Doc Values</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"my_type"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"session_id"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"index"</span>:      <span class="string">"not_analyzed"</span>,</span><br><span class="line">          <span class="attr">"doc_values"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以设置字段 doc_values: true 和 index: no ，该字段无法被搜索到，只能被用于聚合、排序、脚本操作。</p>
<h3 id="聚合与分析-Aggregations-and-Analysis"><a href="#聚合与分析-Aggregations-and-Analysis" class="headerlink" title="聚合与分析(Aggregations and Analysis)"></a>聚合与分析(Aggregations and Analysis)</h3><p>如果对analyzed字符串进行聚合，有两个原因会影响聚合：分析影响聚合中使用的 tokens ，并且 doc values 不能使用于 分析字符串。</p>
<h5 id="分析字符串和Fielddata-Analyzed-strings-and-Fielddata"><a href="#分析字符串和Fielddata-Analyzed-strings-and-Fielddata" class="headerlink" title="分析字符串和Fielddata(Analyzed strings and Fielddata)"></a>分析字符串和Fielddata(Analyzed strings and Fielddata)</h5><ul>
<li>Doc values 不支持 analyzed 字符串字段，因为它们不能很有效的表示多值字符串。Doc values 最有效的是，当每个文档都有一个或几个tokens时， 但不是无数的分析字符串（想象一个 PDF ，可能有几兆字节并有数以千计的独特 tokens）。</li>
<li>如果对分析字符串使用聚合？ 答案是：使用fielddata数据结构。</li>
<li>fielddata构建和管理100%在内存中，常驻于JVM内存堆。</li>
<li>从历史上看，fielddata 是 所有 字段的默认设置。但是 Elasticsearch 已迁移到 doc values 以减少 OOM 的几率。分析的字符串是仍然使用 fielddata 的最后一块阵地。 最终目标是建立一个序列化的数据结构类似于 doc values ，可以处理高维度的分析字符串，逐步淘汰 fielddata。</li>
</ul>
<h5 id="高基数内存的影响-High-Cardinality-Memory-Implications"><a href="#高基数内存的影响-High-Cardinality-Memory-Implications" class="headerlink" title="高基数内存的影响(High-Cardinality Memory Implications)"></a>高基数内存的影响(High-Cardinality Memory Implications)</h5><p>避免分析字段的另外一个原因就是：高基数字段在加载到 fielddata 时会消耗大量内存。<br>分析的过程会经常（尽管不总是这样）生成大量的 token，这些 token 大多都是唯一的。 这会增加字段的整体基数并且带来更大的内存压力。</p>
<p>因此，在聚合字符串字段之前，请评估情况：</p>
<ul>
<li>这是一个 not_analyzed 字段吗？如果是，可以通过 doc values 节省内存 。</li>
<li>否则，这是一个 analyzed 字段，它将使用 fielddata 并加载到内存中。这个字段因为 ngrams 有一个非常大的基数？如果是，这对于内存来说极度不友好。</li>
</ul>
<h3 id="circuit-breaker-fd-settings"><a href="#circuit-breaker-fd-settings" class="headerlink" title="circuit_breaker_fd_settings"></a>circuit_breaker_fd_settings</h3><h3 id="限制内存使用-Limiting-Memory-Usage"><a href="#限制内存使用-Limiting-Memory-Usage" class="headerlink" title="限制内存使用(Limiting Memory Usage)"></a>限制内存使用(Limiting Memory Usage)</h3><ul>
<li>Fielddata 是 延迟 加载。没聚合过分析字符串就不会加载fielddata到内存中。</li>
<li>fielddata 是基于字段加载的， 这意味着只有很活跃地使用字段才会增加 fielddata 的负担。</li>
<li>即是你查询少数几个文档，但fielddata 会加载索引中（针对该特定字段的）所有的文档。</li>
<li>fielddata 在查询运行时，动态填充。</li>
<li>fielddata使用的是JVM堆资源</li>
</ul>
<p>在设置 Elasticsearch 堆大小时需要通过 $ES_HEAP_SIZE 环境变量应用两个规则：</p>
<h5 id="选择堆大小（Choosing-a-Heap-Size）"><a href="#选择堆大小（Choosing-a-Heap-Size）" class="headerlink" title="选择堆大小（Choosing a Heap Size）"></a>选择堆大小（Choosing a Heap Size）</h5><ul>
<li>不要超过可用 RAM 的 50%。Lucene 能很好利用文件系统的缓存，它是通过系统内核管理的。如果没有足够的文件系统缓存空间，性能会受到影响。 此外，专用于堆的内存越多意味着其他所有使用 doc values 的字段内存越少。</li>
<li>不要超过 32 GB。 如果堆大小小于 32 GB，JVM 可以利用指针压缩，这可以大大降低内存的使用：每个指针 4 字节而不是 8 字节。</li>
</ul>
<h5 id="Fielddata的大小"><a href="#Fielddata的大小" class="headerlink" title="Fielddata的大小"></a>Fielddata的大小</h5><ul>
<li>indices.fielddata.cache.size 控制为 fielddata 分配的堆空间大小。</li>
<li>indices.fielddata.cache.size 默认情况下，设置都是 unbounded ，Elasticsearch 永远都不会从 fielddata 中回收数据。</li>
<li>一个有界的大小会强制数据结构回收数据。</li>
<li>一个使用场景：日志，每天使用新索引，只对最近几天数据感兴趣。</li>
</ul>
<blockquote>
<p>如果没有足够空间可以将 fielddata 保留在内存中，Elasticsearch 就会时刻从磁盘重载数据，并回收其他数据以获得更多空间。内存的回收机制会导致重度磁盘I/O，并且在内存中生成很多垃圾，这些垃圾必须在晚些时候被回收掉。</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以设置堆大小的百分比，也可以是某个值，例如： 5gb 。</span></span><br><span class="line"><span class="comment"># 最久未使用（LRU）的 fielddata 会被回收为新数据腾出空间。</span></span><br><span class="line"><span class="meta">indices.fielddata.cache.size</span>:  <span class="string">20%</span></span><br></pre></td></tr></table></figure>

<h5 id="监控fielddata-Monitoring-fielddata"><a href="#监控fielddata-Monitoring-fielddata" class="headerlink" title="监控fielddata(Monitoring fielddata)"></a>监控fielddata(Monitoring fielddata)</h5><p>监控fielddata的内存使用情况，监控数据被回收情况。</p>
<p>监控方法：</p>
<ul>
<li>按索引使用 <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/indices-stats.html" target="_blank" rel="noopener">indices-stats API</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_stats&#x2F;fielddata?fields&#x3D;*</span><br></pre></td></tr></table></figure></li>
<li>按节点使用 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/cluster-nodes-stats.html" target="_blank" rel="noopener">nodes-stats API</a> ：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_nodes&#x2F;stats&#x2F;indices&#x2F;fielddata?fields&#x3D;*</span><br></pre></td></tr></table></figure></li>
<li>按索引节点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_nodes&#x2F;stats&#x2F;indices&#x2F;fielddata?level&#x3D;indices&amp;fields&#x3D;*</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="断路器-Circuit-Breaker"><a href="#断路器-Circuit-Breaker" class="headerlink" title="断路器(Circuit Breaker)"></a>断路器(Circuit Breaker)</h5><p>面临的问题：fielddata大小设置是在数据加载之后才检查的，如果加载的数据大于内存，就会发生OutOfMemoryException。<br>解决方法：使用 fielddata 断路器(Circuit Breaker)。</p>
<p>断路器工作原理：断路器通过内部检查(字段类型，基数，大小等)来估算一个查询需要的内存大小，判断加载的数据是否超出配置比例，如果超出限制就会触发断路器，中止查询并返回异常。<br>断路器工作发生在加载之前，不会引起OutOfMemoryException。</p>
<p>可用的断路器（Available Circuit Breakers）,修改配置config/elasticsearch.yml</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fielddata 断路器, 默认设置堆的 60% 作为 fielddata 大小的上限。</span></span><br><span class="line"><span class="meta">indices.breaker.fielddata.limit</span> : <span class="string">60%</span></span><br><span class="line"><span class="comment"># request 断路器, 估算需要完成其他请求部分的结构大小，例如创建一个聚合桶，默认限制是堆内存的 40%。</span></span><br><span class="line"><span class="meta">indices.breaker.request.limit</span> : <span class="string">40%</span></span><br><span class="line"><span class="comment"># total 结合 request 和 fielddata 断路器保证两者组合起来不会使用超过堆内存的 70%。</span></span><br><span class="line"><span class="meta">indices.breaker.total.limit</span> : <span class="string">70%</span></span><br></pre></td></tr></table></figure>

<p>也可以动态修改</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"persistent"</span> : &#123;</span><br><span class="line">    <span class="attr">"indices.breaker.fielddata.limit"</span> : <span class="string">"40%"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最好为断路器设置一个相对保守点的值。</p>
<blockquote>
<p>记住 fielddata 需要与 request 断路器共享堆内存、索引缓冲内存和过滤器缓存。<br>Lucene 的数据被用来构造索引，以及各种其他临时的数据结构。 正因如此，它默认值非常保守，只有 60% 。过于乐观的设置可能会引起潜在的堆栈溢出（OOM）异常，这会使整个节点宕掉。<br>另一方面，过度保守的值只会返回查询异常，应用程序可以对异常做相应处理。异常比服务器崩溃要好。这些异常应该也能促进我们对查询进行重新评估：为什么单个查询需要超过堆内存的 60% 之多？</p>
</blockquote>
<p>断路器的限制 必须 要比缓存大小要高.</p>
<blockquote>
<p>在 Fielddata的大小 中，我们提过关于给 fielddata 的大小加一个限制，从而确保旧的无用 fielddata 被回收的方法。 indices.fielddata.cache.size 和 indices.breaker.fielddata.limit 之间的关系非常重要。 如果断路器的限制低于缓存大小，没有数据会被回收。为了能正常工作，断路器的限制 必须 要比缓存大小要高。</p>
</blockquote>
<h3 id="Fielddata-的过滤"><a href="#Fielddata-的过滤" class="headerlink" title="Fielddata 的过滤"></a>Fielddata 的过滤</h3><p>Fielddata过滤实际上是在忽略数据，避免大量的无用的长尾项，也可以节省内存。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /music/_mapping/song</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"tag"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"fielddata"</span>: &#123;</span><br><span class="line">        <span class="attr">"filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"frequency"</span>: &#123;</span><br><span class="line">            <span class="attr">"min"</span>:              <span class="number">0.01</span>,</span><br><span class="line">            <span class="attr">"min_segment_size"</span>: <span class="number">500</span>  </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>fielddata 关键字允许我们配置 fielddata 处理该字段的方式。</li>
<li>frequency 过滤器允许我们基于项频率过滤加载 fielddata。</li>
<li>min：0.01 只加载那些至少在本段文档中出现 1% 的项。</li>
<li>min_segment_size :500 忽略任何文档个数小于 500 的段。</li>
</ul>
<p>词频是按照段来计算的。这是实现的一个限制：fielddata 是按段来加载的，所以可见的词频只是该段内的频率。但是，这个限制也有些有趣的特性：它可以让受欢迎的新项迅速提升到顶部。</p>
<p>min_segment_size 参数要求 Elasticsearch 忽略某个大小以下的段。 如果一个段内只有少量文档，它的词频会非常粗略没有任何意义。 小的分段会很快被合并到更大的分段中，某一刻超过这个限制，将会被纳入计算。</p>
<blockquote>
<p>通过频次来过滤项并不是唯一的选择，我们也可以使用正则式来决定只加载那些匹配的项。例如，我们可以用 regex 过滤器 处理 twitte 上的消息只将以 # 号开始的标签加载到内存中。 这假设我们使用的分析器会保留标点符号，像 whitespace 分析器。</p>
</blockquote>
<h3 id="预加载fielddata"><a href="#预加载fielddata" class="headerlink" title="预加载fielddata"></a>预加载fielddata</h3><p>fielddata加载到内存，默认是 延迟 加载。<br>延迟加载：当ES第一次查询某个字段时，它将会完整加载这个字段所有segment中的倒排索引到内存中，以便于以后的查询能够获取更好的性能。</p>
<p>解决延时高峰三种方式:</p>
<ul>
<li>预加载fielddata</li>
<li>预加载全局序号</li>
<li>缓存预热<br>三种方式都基于同一概念：预加载fielddata</li>
</ul>
<h5 id="预加载fielddata-Eagerly-Loading-Fielddata"><a href="#预加载fielddata-Eagerly-Loading-Fielddata" class="headerlink" title="预加载fielddata(Eagerly Loading Fielddata)"></a>预加载fielddata(Eagerly Loading Fielddata)</h5><p>启动字段预加载就是对分段里的fielddata提取加载。<br>预加载是按字段启用的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /music/_mapping/_song</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tags"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">    <span class="attr">"fielddata"</span>: &#123;</span><br><span class="line">      <span class="attr">"loading"</span> : <span class="string">"eager"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置 fielddata.loading: eager 可以告诉 Elasticsearch 预先将此字段的内容载入内存中。</li>
<li>fielddata.loading 支持 lazy, eager 两种模式。</li>
</ul>
<h5 id="全局序号-Global-Ordinals"><a href="#全局序号-Global-Ordinals" class="headerlink" title="全局序号(Global Ordinals)"></a>全局序号(Global Ordinals)</h5><ul>
<li>有一种可以用来降低字符串fielddata内存使用的技术叫做 序号。</li>
<li>字段中包含的所有值用序号来一一对应，加载fielddata时使用序号代替原始值。序号的构建只被应用于字符串。</li>
<li>全局序号是一个构建在 fielddata 之上的数据结构，它只占用少量内存。</li>
<li>唯一值是 跨所有分段 识别的，然后将它们存入一个序号列表中。</li>
<li>terms 聚合可以对全局序号进行聚合操作，将序号转换成真实字符串值的过程只会在聚合结束时发生一次。这会将聚合（和排序）的性能提高三到四倍。</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Ordinal</th>
<th align="left">Term</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">status_deleted</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">status_pending</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">status_published</td>
</tr>
</tbody></table>
<h5 id="构建全局序号-Building-global-ordinals"><a href="#构建全局序号-Building-global-ordinals" class="headerlink" title="构建全局序号(Building global ordinals)"></a>构建全局序号(Building global ordinals)</h5><ul>
<li>全局序号分布在索引的所有段中，所以如果新增或删除一个分段时，需要对全局序号进行重建。</li>
<li>重建需要读取每个分段的每个唯一项，基数越高（即存在更多的唯一项）这个过程会越长。</li>
<li>全局序号默认也是延迟构建的。首次访问索引内 fielddata 的请求会促发全局序号的构建。</li>
<li>一旦全局序号发生重建，仍会使用旧的全局序号，直到索引中的分段产生变化：在刷新、写入或合并之后。</li>
</ul>
<h5 id="预构建全局序号-Eager-global-ordinals"><a href="#预构建全局序号-Eager-global-ordinals" class="headerlink" title="预构建全局序号(Eager global ordinals)"></a>预构建全局序号(Eager global ordinals)</h5><p>单个字符串字段 可以通过配置预先构建全局序号：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /music/_mapping/_song</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"song_title"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">    <span class="attr">"fielddata"</span>: &#123;</span><br><span class="line">      <span class="attr">"loading"</span> : <span class="string">"eager_global_ordinals"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>预建全局序号会对数据的 实时性 产生影响，构建一个高基数的全局序号会使一个刷新延时数秒。 选择在于是每次刷新时付出代价，还是在刷新后的第一次查询时。如果经常索引而查询较少，那么在查询时付出代价要比每次刷新时要好。如果写大于读，那么在选择在查询时重建全局序号将会是一个更好的选择。</p>
<blockquote>
<p>针对实际场景优化全局序号的重建频次。如果我们有高基数字段需要花数秒钟重建，增加 refresh_interval 的刷新的时间从而可以使我们的全局序号保留更长的有效期，这也会节省 CPU 资源，因为我们重建的频次下降了。</p>
</blockquote>
<h3 id="索引预热器-Index-Warmers"><a href="#索引预热器-Index-Warmers" class="headerlink" title="索引预热器(Index Warmers)"></a>索引预热器(Index Warmers)</h3><ul>
<li>预热器早于 fielddata 预加载和全局序号预加载之前出现，它们仍然有其存在的理由。</li>
<li>一个索引预热器允许我们指定一个查询和聚合须要在新分片对于搜索可见之前执行。 这个想法是通过预先填充或 预热缓存 让用户永远无法遇到延迟的波峰。</li>
<li>预热器是根据具体索引注册的， 每个预热器都有唯一的 ID ，因为每个索引可能有多个预热器。</li>
<li>预热器主要用来预建过滤器缓存，也可以用它来预加载 fielddata。</li>
<li>当新建一个分段时，Elasticsearch 将会执行注册在预热器中的查询。执行这些查询会强制加载缓存，只有在所有预热器执行完，这个分段才会对搜索可见。</li>
</ul>
<p>注册一个预热器然后解释发生了什么：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT /music/_warmer/warmer_1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span> : &#123;</span><br><span class="line">    <span class="attr">"bool"</span> : &#123;</span><br><span class="line">      <span class="attr">"filter"</span> : &#123;</span><br><span class="line">        <span class="attr">"bool"</span>: &#123;</span><br><span class="line">          <span class="attr">"should"</span>: [</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"tag"</span>: <span class="string">"rock"</span>        &#125;&#125;,</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"tag"</span>: <span class="string">"hiphop"</span>      &#125;&#125;,</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"tag"</span>: <span class="string">"electronics"</span> &#125;&#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggs"</span> : &#123;</span><br><span class="line">    <span class="attr">"price"</span> : &#123;</span><br><span class="line">      <span class="attr">"histogram"</span> : &#123;</span><br><span class="line">        <span class="attr">"field"</span> : <span class="string">"price"</span>,</span><br><span class="line">        <span class="attr">"interval"</span> : <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>预热器被关联到索引（ music ）上，使用接入口 <code>_warmer</code> 以及 ID （ warmer_1 ）。</li>
<li>should 为三种最受欢迎的曲风预建过滤器缓存。</li>
<li>字段 price 的 fielddata 和全局序号会被预加载。</li>
</ul>
<h3 id="优化聚合查询"><a href="#优化聚合查询" class="headerlink" title="优化聚合查询"></a>优化聚合查询</h3><h5 id="Preventing-Combinatorial-Explosions"><a href="#Preventing-Combinatorial-Explosions" class="headerlink" title="Preventing Combinatorial Explosions"></a>Preventing Combinatorial Explosions</h5><h5 id="深度优先与广度优先-Depth-First-Versus-Breadth-First"><a href="#深度优先与广度优先-Depth-First-Versus-Breadth-First" class="headerlink" title="深度优先与广度优先(Depth-First Versus Breadth-First)"></a>深度优先与广度优先(Depth-First Versus Breadth-First)</h5><ul>
<li>Elasticsearch默认集合模式(collection mode)是 深度优先，它先构建完整的树，然后修剪无用节点。</li>
<li>某些应用场景需要使用 广度优先，广度优先先执行第一层聚合，做修剪完后再继续下一层聚合。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aggs"</span> : &#123;</span><br><span class="line">    <span class="attr">"actors"</span> : &#123;</span><br><span class="line">      <span class="attr">"terms"</span> : &#123;</span><br><span class="line">         <span class="attr">"field"</span> :        <span class="string">"actors"</span>,</span><br><span class="line">         <span class="attr">"size"</span> :         <span class="number">10</span>,</span><br><span class="line">         <span class="attr">"collect_mode"</span> : <span class="string">"breadth_first"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span> : &#123;</span><br><span class="line">        <span class="attr">"costars"</span> : &#123;</span><br><span class="line">          <span class="attr">"terms"</span> : &#123;</span><br><span class="line">            <span class="attr">"field"</span> : <span class="string">"actors"</span>,</span><br><span class="line">            <span class="attr">"size"</span> :  <span class="number">5</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>广度优先仅仅适用于每个组的聚合数量远远小于当前总组数的情况下，因为广度优先会在内存中缓存裁剪后的仅仅需要缓存的每个组的所有数据，以便于它的子聚合分组查询可以复用上级聚合的数据。</p>
<p>广度优先的内存使用情况与裁剪后的缓存分组数据量是成线性的。对于很多聚合来说，每个桶内的文档数量是相当大的。 想象一种按月分组的直方图，总组数肯定是固定的，因为每年只有12个月，这个时候每个月下的数据量可能非常大。这使广度优先不是一个好的选择，这也是为什么深度优先作为默认策略的原因。</p>
<p>针对上面演员的例子，如果数据量越大，那么默认的使用深度优先的聚合模式生成的总分组数就会非常多，但是预估二级的聚合字段分组后的数据量相比总的分组数会小很多所以这种情况下使用广度优先的模式能大大节省内存，从而通过优化聚合模式来大大提高了在某些特定场景下聚合查询的成功率。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>桶与度量的嵌套能力，</li>
<li>基数与百分位数的快速估算能力，定位信息中统计异常的能力</li>
<li>只有不分词的 string 类型的字段才能使用Doc Values</li>
</ul>
<p>内存的管理形式有多种形式，这取决于我们特定的应用场景：</p>
<ul>
<li>在规划时，组织好数据，使聚合运行在 not_analyzed 字符串而不是 analyzed 字符串，这样可以有效的利用 doc values 。</li>
<li>在测试时，验证分析链不会在之后的聚合计算中创建高基数字段。</li>
<li>在搜索时，合理利用近似聚合和数据过滤。</li>
<li>在节点层，设置硬内存大小以及动态的断熔限制。</li>
<li>在应用层，通过监控集群内存的使用情况和 Full GC 的发生频率，来调整是否需要给集群资源添加更多的机器节点</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/16/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/37-%E8%81%9A%E5%90%88-%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/16/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/37-%E8%81%9A%E5%90%88-%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">37-聚合-总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-16 09:52:57" itemprop="dateCreated datePublished" datetime="2020-03-16T09:52:57+08:00">2020-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:54:46" itemprop="dateModified" datetime="2020-05-26T13:54:46+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>30</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a><br>###</p>
<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/15/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/26-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E6%8B%BC%E5%86%99%E9%94%99%E8%AF%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/15/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/26-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E6%8B%BC%E5%86%99%E9%94%99%E8%AF%AF/" class="post-title-link" itemprop="url">26-处理人类语言-拼写错误</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-15 14:33:57" itemprop="dateCreated datePublished" datetime="2020-03-15T14:33:57+08:00">2020-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:51" itemprop="dateModified" datetime="2020-05-26T13:53:51+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a></p>
<h3 id="拼写错误-Typoes-and-Mispelings"><a href="#拼写错误-Typoes-and-Mispelings" class="headerlink" title="拼写错误(Typoes and Mispelings)"></a>拼写错误(Typoes and Mispelings)</h3><p>Fuzzy matching 允许查询时匹配错误拼写的单词，<br>而语音语汇单元过滤器(phonetic token filters)可以在索引时用来进行 近似读音 匹配。</p>
<h3 id="模糊性"><a href="#模糊性" class="headerlink" title="模糊性"></a>模糊性</h3><p>3中操作：</p>
<ul>
<li><p>一个字符 替换 另一个字符： <code>_f_ox → _b_ox</code></p>
</li>
<li><p>插入 一个新的字符：<code>sic → sic_k_</code></p>
</li>
<li><p>删除 一个字符：<code>b_l_ack → back</code></p>
</li>
<li><p>编辑距离: 将一个单词转为另一个单词所需要的编辑次数 称为 编辑距离。</p>
</li>
<li><p>Damerau 发现 80% 的拼写错误编辑距离为 1 。换句话说， 80% 的拼写错误可以对原始字符串用 单次编辑 进行修正。</p>
</li>
<li><p>fuzziness 参数支持对最大编辑距离的配置，默认为 ２ 。</p>
</li>
<li><p>fuzziness 参数可以被设置为 AUTO</p>
<ul>
<li>字符串只有 1 到 2 个字符时是 0</li>
<li>字符串有 3 、 4 或者 5 个字符时是 1</li>
<li>字符串大于 5 个字符时是 2</li>
</ul>
</li>
</ul>
<h3 id="模糊查询-Fuzziness"><a href="#模糊查询-Fuzziness" class="headerlink" title="模糊查询(Fuzziness)"></a>模糊查询(Fuzziness)</h3><p>fuzzy查询(fuzzy query)是 term 查询的模糊等价。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/my_type/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"text"</span>: <span class="string">"Surprise me!"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"text"</span>: <span class="string">"That was surprising."</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"text"</span>: <span class="string">"I wasn't surprised."</span>&#125;</span><br></pre></td></tr></table></figure>
<p>模糊查询，编辑距离设置为1。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"fuzzy"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"surprize"</span>,</span><br><span class="line">        <span class="attr">"fuzziness"</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="提高性能"><a href="#提高性能" class="headerlink" title="提高性能"></a>提高性能</h5><ul>
<li>fuzzy查询工作原理：给定原始词项及构造一个编辑自动机(像表示所有原始字符串指定编辑距离的字符串的一个)大图表。然后模糊查询使用这个自动机依次高效遍历词典中的所有词项以确定是否匹配。 一旦收集了词典中存在的所有匹配项，就可以计算匹配文档列表。</li>
</ul>
<p>下面两个参数可以用来限制对性能的影响:</p>
<ul>
<li>profix_length :不能被 “模糊化” 的初始字符数。 大部分的拼写错误发生在词的结尾，而不是词的开始。 例如通过将 prefix_length 设置为 3 ，你可能够显著降低匹配的词项数量。</li>
<li>max_expansions : 如果一个模糊查询扩展了三个或四个模糊选项， 这些新的模糊选项也许是有意义的。如果它产生 1000 个模糊选项，那么就基本没有意义了。 设置 max_expansions 用来限制将产生的模糊选项的总数量。模糊查询将收集匹配词项直到达到 max_expansions 的限制。</li>
</ul>
<h3 id="模糊匹配查询"><a href="#模糊匹配查询" class="headerlink" title="模糊匹配查询"></a>模糊匹配查询</h3><ul>
<li>match 查询支持模糊匹配(fuzziness)</li>
<li>mutil_match查询也支持模糊查询(fuzziness),但只要类型是 best_fields或 most_fields。</li>
<li>match 和 multi_match 查询都支持 prefix_length 和 max_expansions 参数。</li>
<li>不能使用场景: 模糊性（Fuzziness）只能在 match and multi_match 查询中使用。不能使用在短语匹配、常用词项或 cross_fields 匹配。</li>
</ul>
<p>match 查询支持模糊匹配(fuzziness)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: &#123;</span><br><span class="line">        <span class="attr">"query"</span>:     <span class="string">"SURPRIZE ME!"</span>,</span><br><span class="line">        <span class="attr">"fuzziness"</span>: <span class="string">"AUTO"</span>,</span><br><span class="line">        <span class="attr">"operator"</span>:  <span class="string">"and"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mutil_match查询也支持模糊查询(fuzziness),但只要类型是 best_fields或 most_fields。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"fields"</span>:  [ <span class="string">"text"</span>, <span class="string">"title"</span> ],</span><br><span class="line">      <span class="attr">"query"</span>:     <span class="string">"SURPRIZE ME!"</span>,</span><br><span class="line">      <span class="attr">"fuzziness"</span>: <span class="string">"AUTO"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="模糊性评分-Scoring-Fuzziness"><a href="#模糊性评分-Scoring-Fuzziness" class="headerlink" title="模糊性评分(Scoring Fuzziness)"></a>模糊性评分(Scoring Fuzziness)</h3><ul>
<li>虽然用户喜欢模糊查询，但实际效果平平。</li>
<li>模糊匹配不应用于参与评分—​只能在有拼写错误时扩大匹配项的范围。</li>
<li>默认情况下， match 查询给定所有的模糊匹配的恒定评分为1。</li>
<li>模糊查询常用与其他特性结合使用，比如：search-as-you-type(完成建议)，did-you-mean(短语建议)</li>
</ul>
<h3 id="语音匹配-Phonetic-Matching"><a href="#语音匹配-Phonetic-Matching" class="headerlink" title="语音匹配(Phonetic Matching)"></a>语音匹配(Phonetic Matching)</h3><ul>
<li>语音匹配就是搜索发音相似的词</li>
<li>语音算法：将词转换成语音标识的算法。 Soundex 是最早的算法,其他算法是Soundex的改进版， Metaphone，Double Metaphone， Caverphone ，Beider-Morse ，Kölner Phonetik</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"dbl_metaphone"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:    <span class="string">"phonetic"</span>,</span><br><span class="line">          <span class="attr">"encoder"</span>: <span class="string">"double_metaphone"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"dbl_metaphone"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:    <span class="string">"dbl_metaphone"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>analyze API 测试</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze?analyzer=dbl_metaphone</span><br><span class="line">Smith Smythe</span><br></pre></td></tr></table></figure>

<p>设置mapping</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping/my_type</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: &#123;</span><br><span class="line">        <span class="attr">"phonetic"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>: <span class="string">"dbl_metaphone"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/my_type/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"John Smith"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/my_type/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Jonnie Smythe"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用 match 查询来进行搜索：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"name.phonetic"</span>: &#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Jahnnie Smeeth"</span>,</span><br><span class="line">        <span class="attr">"operator"</span>: <span class="string">"and"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>用语音算法计算评分是没有价值的</li>
<li>语音匹配的目的不是为了提高精度，而是要提高召回率—​以扩展足够的范围来捕获可能匹配的文档</li>
<li>通常更有意义的使用语音算法是在检索到结果后，由另一台计算机进行消费和后续处理，而不是由人类用户直接使用。</li>
</ul>
<p>###</p>
<p>###</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/24-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%81%9C%E7%94%A8%E8%AF%8D-%E6%80%A7%E8%83%BD%E4%B8%8E%E7%B2%BE%E5%BA%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/24-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%81%9C%E7%94%A8%E8%AF%8D-%E6%80%A7%E8%83%BD%E4%B8%8E%E7%B2%BE%E5%BA%A6/" class="post-title-link" itemprop="url">03-处理人类语言-停用词：性能与精度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-13 20:21:57" itemprop="dateCreated datePublished" datetime="2020-03-13T20:21:57+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:51" itemprop="dateModified" datetime="2020-05-26T13:53:51+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a></p>
<h3 id="停用词：性能与精度-Stopwords-Performance-Versus-Precision"><a href="#停用词：性能与精度-Stopwords-Performance-Versus-Precision" class="headerlink" title="停用词：性能与精度(Stopwords: Performance Versus Precision)"></a>停用词：性能与精度(Stopwords: Performance Versus Precision)</h3><p>两组被过滤的词：</p>
<ul>
<li>低频词(Low-frequency terms) : 在文档集合中相对出现较少的词，因为它们稀少，所以它们的权重值更高。</li>
<li>高频词(High-frequcncy terms) : 在索引下的文档集合中出现较多的常用词，例如 the、and、和<code>is</code>。 这些词的权重小，对相关度评分影响不大。</li>
</ul>
<p>英语中停用词通常在索引前就别过滤掉，对检索负面影响不大。</p>
<h3 id="停用词的优缺点"><a href="#停用词的优缺点" class="headerlink" title="停用词的优缺点"></a>停用词的优缺点</h3><p>优点：占用空间小，搜索性能高<br>缺点：降低搜索某些语句的能力</p>
<h3 id="使用停用词"><a href="#使用停用词" class="headerlink" title="使用停用词"></a>使用停用词</h3><ul>
<li>移除停用词的工作是由 stop 停用词过滤器完成的</li>
<li>可以通过创建自定义的分析器来使用它</li>
</ul>
<p>下面分析器内部预置了停用词过滤器：</p>
<ul>
<li>语言分析器 ： 每个语言分析器默认使用与该语言相适的停用词列表</li>
<li>standard 标准分析器：默认使用空的停用词列表：<code>_none_</code> ，实际上是禁用了停用词。</li>
<li>pattern 模式分析器:默认使用空的停用词列表：为 <code>_none_</code> ，与 standard 分析器类似。</li>
</ul>
<h5 id="停用词和标准分析器（Stopwords-and-the-Standard-Analyzer）"><a href="#停用词和标准分析器（Stopwords-and-the-Standard-Analyzer）" class="headerlink" title="停用词和标准分析器（Stopwords and the Standard Analyzer）"></a>停用词和标准分析器（Stopwords and the Standard Analyzer）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_analyzer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"stopwords"</span>: [ <span class="string">"and"</span>, <span class="string">"the"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="保持位置（Maintaining-Positions）"><a href="#保持位置（Maintaining-Positions）" class="headerlink" title="保持位置（Maintaining Positions）"></a>保持位置（Maintaining Positions）</h5><p>保留停用词和移除停用词，对其他词汇单元的位置保持不变。</p>
<h5 id="指定停用词-Specifying-Stopwords"><a href="#指定停用词-Specifying-Stopwords" class="headerlink" title="指定停用词(Specifying Stopwords)"></a>指定停用词(Specifying Stopwords)</h5><p>使用stopwords指定停用词，可以指定停用词数组，也可以通过 <code>_lang_</code> 默认停用词。</p>
<p>语言相关停用词列表 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/analysis-stop-tokenfilter.html" target="_blank" rel="noopener">stop 停用词过滤器​</a></p>
<p>可以特殊列表 <code>_none_</code> 来禁用。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_english"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:      <span class="string">"english"</span>,</span><br><span class="line">          <span class="attr">"stopwords"</span>: <span class="string">"_none_"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 stopwords_path 参数设置停用词文件路径。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_english"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:           <span class="string">"english"</span>,</span><br><span class="line">          <span class="attr">"stopwords_path"</span>: <span class="string">"stopwords/english.txt"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用停用词过滤器（Using-the-stop-Token-Filter）"><a href="#使用停用词过滤器（Using-the-stop-Token-Filter）" class="headerlink" title="使用停用词过滤器（Using the stop Token Filter）"></a>使用停用词过滤器（Using the stop Token Filter）</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"spanish_stop"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:        <span class="string">"stop"</span>,</span><br><span class="line">          <span class="attr">"stopwords"</span>: [ <span class="string">"si"</span>, <span class="string">"esta"</span>, <span class="string">"el"</span>, <span class="string">"la"</span> ]  </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"light_spanish"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"stemmer"</span>,</span><br><span class="line">          <span class="attr">"language"</span>: <span class="string">"light_spanish"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_spanish"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"spanish"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"asciifolding"</span>,</span><br><span class="line">            <span class="string">"spanish_stop"</span>,</span><br><span class="line">            <span class="string">"light_spanish"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="更新停用词（Updating-Stopwords）"><a href="#更新停用词（Updating-Stopwords）" class="headerlink" title="更新停用词（Updating Stopwords）"></a>更新停用词（Updating Stopwords）</h5><p>更新停用词时机：</p>
<ul>
<li>分析器在创建索引时。</li>
<li>当集群节点重启时候。</li>
<li>关闭的索引重新打开的时候。</li>
</ul>
<ol>
<li>内联式 需要关闭索引，更新配置，再重新打开索引。stopwords 参数以内联方式指定停用词，只能通过关闭索引，更新分析器的配置，然后在重新打开索引才能更新停用词。</li>
<li>停用词文件，直接更新文件就可以。</li>
</ol>
<h3 id="停用词与性能-Stopwords-Performance-Versus-Precision"><a href="#停用词与性能-Stopwords-Performance-Versus-Precision" class="headerlink" title="停用词与性能(Stopwords: Performance Versus Precision)"></a>停用词与性能(Stopwords: Performance Versus Precision)</h3><p>保留停用词最大的缺点就是影响搜索性能。<br>问题分析：停用词出现频率高，搜索时包含停用词，返回的文档数量会很多。<br>减少文档数量的方法:</p>
<ol>
<li>and 操作符</li>
<li>最少匹配数(minimum_should_match)</li>
</ol>
<h5 id="and-操作符-and-Operator"><a href="#and-操作符-and-Operator" class="headerlink" title="and 操作符(and Operator)"></a>and 操作符(and Operator)</h5><p>减少待评分文档数量最简单的方法：match查询时使用and 操作符。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">        <span class="attr">"text"</span>: &#123;</span><br><span class="line">            <span class="attr">"query"</span>:    <span class="string">"the quick brown fox"</span>,</span><br><span class="line">            <span class="attr">"operator"</span>: <span class="string">"and"</span></span><br><span class="line">             &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重写为bool查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">        <span class="attr">"must"</span>: [</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"the"</span> &#125;&#125;,</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"brown"</span> &#125;&#125;,</span><br><span class="line">            &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"fox"</span> &#125;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>bool 查询会智能的根据较优的顺序依次执行每个 term 查询：它会从最低频的词开始。因为所有词项都必须匹配，只要包含低频词的文档才有可能匹配。使用 and 操作符可以大大提升多词查询的速度。</p>
<h5 id="最少匹配数-minimum-should-match"><a href="#最少匹配数-minimum-should-match" class="headerlink" title="最少匹配数(minimum_should_match)"></a>最少匹配数(minimum_should_match)</h5><p>使用最少匹配数(minimum_should_match)去掉结果中次相关的长尾。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">        <span class="attr">"text"</span>: &#123;</span><br><span class="line">            <span class="attr">"query"</span>: <span class="string">"the quick brown fox"</span>,</span><br><span class="line">            <span class="attr">"minimum_should_match"</span>: <span class="string">"75%"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例中四分之三的词都必须匹配，查询时考虑低频率的词，相比or操作，性能有巨大提升。</p>
<h3 id="词项的分别管理-Divide-and-Conquer"><a href="#词项的分别管理-Divide-and-Conquer" class="headerlink" title="词项的分别管理(Divide and Conquer)"></a>词项的分别管理(Divide and Conquer)</h3><ul>
<li>查询字符串中的词项(terms)可以分为： 更重要(低频词)，次重要(高频词)。低频词组成 bulk 大量查询条件，高频词只会用来评分，不参与匹配过程。</li>
<li>使用参数cutoff_frequency将词项分为 低频和高频，超过cutoff_frequency值的为高频词。</li>
<li>使用参数cutoff_frequency的好处：特定领域 使用的停用词不受约束，它根据词项的词频过滤文档不是stop过滤器中的停用词列表。</li>
<li>cutoff_frequency 配置可以指定为一个分数（ 0.01 = 1% ）或者一个正整数（ 5 ）。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"match"</span>: &#123;</span><br><span class="line">    <span class="attr">"text"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"Quick and the dead"</span>,</span><br><span class="line">      <span class="attr">"cutoff_frequency"</span>: <span class="number">0.01</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被重新为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"bool"</span>: &#123;</span><br><span class="line">    <span class="attr">"must"</span>: &#123;</span><br><span class="line">      <span class="attr">"bool"</span>: &#123;</span><br><span class="line">        <span class="attr">"should"</span>: [</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"dead"</span>  &#125;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"should"</span>: &#123;</span><br><span class="line">      <span class="attr">"bool"</span>: &#123;</span><br><span class="line">        <span class="attr">"should"</span>: [</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"and"</span> &#125;&#125;,</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"the"</span> &#125;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="控制精度"><a href="#控制精度" class="headerlink" title="控制精度"></a>控制精度</h5><p>minimum_should_match 参数结合 cutoff_frequency 使用，可以控制精度。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"match"</span>: &#123;</span><br><span class="line">    <span class="attr">"text"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"Quick and the dead"</span>,</span><br><span class="line">      <span class="attr">"cutoff_frequency"</span>: <span class="number">0.01</span>,</span><br><span class="line">      <span class="attr">"minimum_should_match"</span>: <span class="string">"75%"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被重写为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"bool"</span>: &#123;</span><br><span class="line">    <span class="attr">"must"</span>: &#123;</span><br><span class="line">      <span class="attr">"bool"</span>: &#123;</span><br><span class="line">        <span class="attr">"should"</span>: [</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"dead"</span>  &#125;&#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"minimum_should_match"</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"should"</span>: &#123;</span><br><span class="line">      <span class="attr">"bool"</span>: &#123;</span><br><span class="line">        <span class="attr">"should"</span>: [</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"and"</span> &#125;&#125;,</span><br><span class="line">          &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"the"</span> &#125;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>minimum_should_match=1　因为只有两个词，原来的75%向下取整为 1 ，意思是：必须匹配低频词的两者之一。</li>
<li>should(and,the)　高频词仍可选的，并且仅用于评分使用。</li>
</ul>
<h5 id="高频次"><a href="#高频次" class="headerlink" title="高频次"></a>高频次</h5><p>如果想返回所有包含高频词的文档，使用must-or查询.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"bool"</span>: &#123;</span><br><span class="line">    <span class="attr">"must"</span>: [</span><br><span class="line">      &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"to"</span> &#125;&#125;,</span><br><span class="line">      &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"be"</span> &#125;&#125;,</span><br><span class="line">      &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"or"</span> &#125;&#125;,</span><br><span class="line">      &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"not"</span> &#125;&#125;,</span><br><span class="line">      &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"to"</span> &#125;&#125;,</span><br><span class="line">      &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"be"</span> &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="对常用词使用更多控制-More-Control-with-Common-Terms"><a href="#对常用词使用更多控制-More-Control-with-Common-Terms" class="headerlink" title="对常用词使用更多控制(More Control with Common Terms)"></a>对常用词使用更多控制(More Control with Common Terms)</h5><p>使用更多参数进行控制(cutoff_frequency,low_freq_operator,low_freq,high_freq)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"common"</span>: &#123;</span><br><span class="line">    <span class="attr">"text"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>:                  <span class="string">"Quick and the dead"</span>,</span><br><span class="line">      <span class="attr">"cutoff_frequency"</span>:       <span class="number">0.01</span>,</span><br><span class="line">      <span class="attr">"low_freq_operator"</span>:      <span class="string">"and"</span>,</span><br><span class="line">      <span class="attr">"minimum_should_match"</span>: &#123;</span><br><span class="line">        <span class="attr">"high_freq"</span>:            <span class="string">"75%"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>“low_freq_operator”: “and”, 所有低频词都必须匹配</li>
<li>“high_freq”: “75%”，对超过 75% 的高频词文档进行评分</li>
</ol>
<p>更多配置项参见　<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-common-terms-query.html" target="_blank" rel="noopener">common terms query</a></p>
<h3 id="停用词和短语查询-Stopwords-and-Phrase-Queries"><a href="#停用词和短语查询-Stopwords-and-Phrase-Queries" class="headerlink" title="停用词和短语查询(Stopwords and Phrase Queries)"></a>停用词和短语查询(Stopwords and Phrase Queries)</h3><p>典型索引包含内容：</p>
<ul>
<li>词项字段(Terms dictionary): 索引中所有文档内所有词项的有序列表，以及包含该词的文档数量。</li>
<li>倒排表(Postings list): 包含每个词项的文档（ID）列表。</li>
<li>词频(Term frequency) : 每个词项在每个文档里出现的频率。</li>
<li>位置(Positions) : 每个词项在每个文档里出现的位置，供短语查询或近似查询使用。</li>
<li>偏移(Offsets): 每个词项在每个文档里开始与结束字符的偏移，供词语高亮使用，默认是禁用的。</li>
<li>规范因子（Norms）: 用来对字段长度进行规范化处理的因子，给较短字段予以更多权重。</li>
</ul>
<p>将停用词从索引中移除会节省 词项字典 和 倒排表 里的少量空间，但位置和偏移是另一码事。<br>位置和偏移数据很容易变成索引大小的两倍、三倍、甚至四倍。</p>
<h5 id="位置信息"><a href="#位置信息" class="headerlink" title="位置信息"></a>位置信息</h5><p>位置信息默认是开启的，词项出现越频繁位置信息所占空间就越多。</p>
<h5 id="索引选项"><a href="#索引选项" class="headerlink" title="索引选项"></a>索引选项</h5><p>是否真的需要使用短语查询或 近似查询？答案通常是 ：不需要。<br>使用index_options参数控制索引里每个字段的存储信息。<br>选项：</p>
<ul>
<li>docs：只存储文档及其包含词项的信息。这对 not_analyzed 字符串字段是默认的。</li>
<li>freqs: 存储docs信息和词频。如果只想知道：文档是否包含某词项，则不需使用它。</li>
<li>positions: 存储 docs 、 freqs 、 analyzed和每个词项的位置。nalyzed 字符串字段是默认的，但当不需使用短语或近似匹配时，可以将其禁用。</li>
<li>offsets : 存储docs 、 freqs 、 positions和原始字符串的偏移量。这个信息被用以高亮搜索结果，但它默认是禁用的。</li>
</ul>
<p>例如:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"my_type"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:          <span class="string">"string"</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="attr">"content"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:          <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"index_options"</span>: <span class="string">"freqs"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="停用词"><a href="#停用词" class="headerlink" title="停用词"></a>停用词</h5><p>删除停用词可以节省空间提高查询性能，但也降低了搜索能力。<br>幸运的是可以通过common_grams 过滤器，让两者兼得。</p>
<h3 id="common-grams过滤器-common-grams-Token-Filter"><a href="#common-grams过滤器-common-grams-Token-Filter" class="headerlink" title="common_grams过滤器(common_grams Token Filter)"></a>common_grams过滤器(common_grams Token Filter)</h3><p>为使短语查询能更高效的使用停用词，设计了common_grams过滤器，与shingles过滤器类似，<br>query_mode ：false(为索引使用,默认), true (为搜索使用)。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"index_filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:         <span class="string">"common_grams"</span>,</span><br><span class="line">          <span class="attr">"common_words"</span>: <span class="string">"_english_"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"search_filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:         <span class="string">"common_grams"</span>,</span><br><span class="line">          <span class="attr">"common_words"</span>: <span class="string">"_english_"</span>,</span><br><span class="line">          <span class="attr">"query_mode"</span>:   <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"index_grams"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>:  <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:   [ <span class="string">"lowercase"</span>, <span class="string">"index_filter"</span> ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"search_grams"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"lowercase"</span>, <span class="string">"search_filter"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>基于 common_grams 过滤器创建两个过滤器,index_filter 在索引时使用，search_filter 在查询时使用</li>
<li>common_words 接受<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/using-stopwords.html#specifying-stopwords" target="_blank" rel="noopener">指定停用词</a>,例如：none,<code>_english_</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping/my_type</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"text"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>:            <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"analyzer"</span>:  <span class="string">"index_grams"</span>,</span><br><span class="line">      <span class="attr">"search_analyzer"</span>: <span class="string">"standard"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="索引时-At-Index-Time"><a href="#索引时-At-Index-Time" class="headerlink" title="索引时(At Index Time)"></a>索引时(At Index Time)</h5><p>索引时common_gram生成数据格式如下:<br><code>The quick and brown fox</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pos 1: the, the_quick</span><br><span class="line">Pos 2: quick, quick_and</span><br><span class="line">Pos 3: and, and_brown</span><br><span class="line">Pos 4: brown</span><br><span class="line">Pos 5: fox</span><br></pre></td></tr></table></figure>
<ul>
<li>所有的词项都是unigrams 形式输出</li>
<li>如果一个词本身是常用词或者跟随着常用词时，以bigram形式输出：the_quick，quick_and，and_brown</li>
</ul>
<h5 id="单字查询-Unigram-Queries"><a href="#单字查询-Unigram-Queries" class="headerlink" title="单字查询(Unigram Queries)"></a>单字查询(Unigram Queries)</h5><p>单字查询可以正常使用</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: &#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"the quick and brown fox"</span>,</span><br><span class="line">        <span class="attr">"cutoff_frequency"</span>: <span class="number">0.01</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="二元语法短语查询-Bigram-Phrase-Queries"><a href="#二元语法短语查询-Bigram-Phrase-Queries" class="headerlink" title="二元语法短语查询(Bigram Phrase Queries)"></a>二元语法短语查询(Bigram Phrase Queries)</h5><p>进行短语查询时使用专门的search_grams分析器让过程变的更高效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_phrase"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: &#123;</span><br><span class="line">        <span class="attr">"query"</span>:    <span class="string">"The quick and brown fox"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"search_grams"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>search_grams 分析器会生成以下词项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pos 1: the_quick</span><br><span class="line">Pos 2: quick_and</span><br><span class="line">Pos 3: and_brown</span><br><span class="line">Pos 4: brown</span><br><span class="line">Pos 5: fox</span><br></pre></td></tr></table></figure>

<h5 id="两词短语（Two-Word-Phrases）"><a href="#两词短语（Two-Word-Phrases）" class="headerlink" title="两词短语（Two-Word Phrases）"></a>两词短语（Two-Word Phrases）</h5><h3 id="停用词与相关性-Stopwords-and-Relevance"><a href="#停用词与相关性-Stopwords-and-Relevance" class="headerlink" title="停用词与相关性(Stopwords and Relevance)"></a>停用词与相关性(Stopwords and Relevance)</h3><p>在索引中保留停用词会降低相关度计算的准确性，特别是当我们的文档非常长时。<br>如果一个长文档中停用很多，词频饱和度没有设置上限，则其他常用词的词频会降低。<br>考虑对包含停用词的较长字段使用使用Okapi BM25，设置词频饱和度。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/23-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%B0%86%E5%8D%95%E8%AF%8D%E8%BF%98%E5%8E%9F%E4%B8%BA%E8%AF%8D%E6%A0%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/23-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%B0%86%E5%8D%95%E8%AF%8D%E8%BF%98%E5%8E%9F%E4%B8%BA%E8%AF%8D%E6%A0%B9/" class="post-title-link" itemprop="url">03-处理人类语言-将单词还原为词根</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-13 11:00:57" itemprop="dateCreated datePublished" datetime="2020-03-13T11:00:57+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:51" itemprop="dateModified" datetime="2020-05-26T13:53:51+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a><br>参考：<br>230_Stemming<br><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/stemming.html" target="_blank" rel="noopener">https://www.elastic.co/guide/cn/elasticsearch/guide/current/stemming.html</a><br><a href="https://github.com/elastic/elasticsearch-definitive-guide/tree/master/230_Stemming" target="_blank" rel="noopener">https://github.com/elastic/elasticsearch-definitive-guide/tree/master/230_Stemming</a></p>
<h3 id="将单词还原为词根-Reducing-Words-to-Their-Root-Form"><a href="#将单词还原为词根-Reducing-Words-to-Their-Root-Form" class="headerlink" title="将单词还原为词根(Reducing Words to Their Root Form)"></a>将单词还原为词根(Reducing Words to Their Root Form)</h3><ul>
<li>大多数语言的单词都可以 词形变化。</li>
<li>词根提取(Stemming) ：试图移除单词的变化形式之间的差别，将每个单词都提取为它的词根形式。有的词根不是一个真的单词.</li>
<li>词根提取遇到的两个问题：词干弱提取(understemming)，词干过度提取(overstemming)</li>
<li>词干弱提取(understemming): 无法将同样意思的单词缩减为同一个词根。弱词干提取会导致搜索时无法返回相关文档。</li>
<li>词根过渡提取(overstemming):无法将不同含义的单词分开。词干过度提取会降低精准度：不相干的文档会在不需要他们返回的时候返回。</li>
<li>ES提供两个经典词干提取器：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/algorithmic-stemmers.html" target="_blank" rel="noopener">词干提取算法</a>,<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/dictionary-stemmers.html" target="_blank" rel="noopener">字典词干提取器</a></li>
<li>词形还原：</li>
</ul>
<p>词形变化：</p>
<ul>
<li>单复数变化(Number) ： fox 、foxes</li>
<li>时态变化(Tense) ： pay 、 paid 、 paying</li>
<li>性别变化(Gender) ： waiter 、 waitress</li>
<li>动词人称变化(Person) ： hear 、 hears</li>
<li>代词变化(Case) ： I 、 me 、 my</li>
<li>不规则变化(Aspect) ： ate 、 eaten</li>
<li>情景变化(Mood) ： so be it 、 were it so</li>
</ul>
<h3 id="词干提取算法-Algorithmic-Stemmers"><a href="#词干提取算法-Algorithmic-Stemmers" class="headerlink" title="词干提取算法(Algorithmic Stemmers)"></a>词干提取算法(Algorithmic Stemmers)</h3><p>词干提取器(stemmer) : 大部分词干提取器是基于算法的，提供一系列规则将词提取为词干。<br>基于算法的提取器<br>优点：作为插件使用，速度快，占用内存少，有规律的单词处理效果好。<br>缺点：没规律的单词效果不好</p>
<p>最早的英文词干提取器是 Porter stemmer. 现在仍然推荐。<br>kstem token filter 是一款合并了词干提取算法和内置词典的英语分词过滤器。<br>所有基于算法的词干提取器都暴露了用来接受 语言 参数的统一接口： stemmer token filter 。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"english_stop"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"stop"</span>,</span><br><span class="line">          <span class="attr">"stopwords"</span>:  <span class="string">"_english_"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"light_english_stemmer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"stemmer"</span>,</span><br><span class="line">          <span class="attr">"language"</span>:   <span class="string">"light_english"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"english_possessive_stemmer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"stemmer"</span>,</span><br><span class="line">          <span class="attr">"language"</span>:   <span class="string">"possessive_english"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"english"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>:  <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"english_possessive_stemmer"</span>,</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"english_stop"</span>,</span><br><span class="line">            <span class="string">"light_english_stemmer"</span>,</span><br><span class="line">            <span class="string">"asciifolding"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>english 分析器使用了两个词干提取器： possessive_english 词干提取器和 english 词干提取器。 所有格词干提取器会在任何词传递到 english_stop 、 english_keywords 和 english_stemmer 之前去除 ‘s 。</li>
<li>light_english 词干提取器: 非激进的 kstem 分词过滤器的映射</li>
<li>asciifolding 分词过滤器用以移除外语的附加符号。</li>
</ul>
<h3 id="字典词干提取器-Dictionary-Stemmers"><a href="#字典词干提取器-Dictionary-Stemmers" class="headerlink" title="字典词干提取器(Dictionary Stemmers)"></a>字典词干提取器(Dictionary Stemmers)</h3><ul>
<li>字典词干提取器只是简单地在字典里查找词</li>
<li>字典词干提取器可以：<ul>
<li>返回不规则形式如 feet 和 mice 的正确词干</li>
<li>区分出词形相似但词义不同的情形，比如 organ and organization</li>
</ul>
</li>
</ul>
<p>实践中一个好的算法化词干提取器一般优于一个字典词干提取器。<br>原因如下：</p>
<ol>
<li>字典质量。词的含义随时光变迁，字典需要保持最新，对于字典中不存在的词无能为力。</li>
<li>大小与性能。字典词干提取器需要加载所有词汇、前缀、后缀到内存中。</li>
</ol>
<h3 id="Hunspell词干提取器-Hunspell-Stemmer"><a href="#Hunspell词干提取器-Hunspell-Stemmer" class="headerlink" title="Hunspell词干提取器(Hunspell Stemmer)"></a>Hunspell词干提取器(Hunspell Stemmer)</h3><p>Hunspell词干提取器是基于词典的，众多其它开源项目都在使用的拼写检查器。地址：hunspell.github.io</p>
<p>Hunspell 词典由两个文件：</p>
<ul>
<li>.dic : 包含所有词根，采用字母顺序，再加上一个代表所有可能前缀和后缀的代码表 【集体称之为词缀( affixes 】</li>
<li>.aff : 包含实际 .dic 文件每一行代码表对应的前缀和后缀转换</li>
</ul>
<h5 id="安装一个字典"><a href="#安装一个字典" class="headerlink" title="安装一个字典"></a>安装一个字典</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config/</span><br><span class="line">  └ hunspell/</span><br><span class="line">      └ en_US/</span><br><span class="line">          ├ en_US.dic</span><br><span class="line">          ├ en_US.aff</span><br><span class="line">          └ settings.yml</span><br></pre></td></tr></table></figure>

<h5 id="按语言设置"><a href="#按语言设置" class="headerlink" title="按语言设置"></a>按语言设置</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ignore_case</span>:          <span class="string">true //Hunspell 目录默认是区分大小写的</span></span><br><span class="line"><span class="attr">strict_affix_parsing</span>: <span class="string">true //strict_affix_parsing 为 false 来告诉 Lucene 忽略错误的规则</span></span><br></pre></td></tr></table></figure>

<p>添加自定义词典 custom.dic</p>
<h5 id="创建一个Humspell语汇单元过滤器"><a href="#创建一个Humspell语汇单元过滤器" class="headerlink" title="创建一个Humspell语汇单元过滤器"></a>创建一个Humspell语汇单元过滤器</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"en_US"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"hunspell"</span>,</span><br><span class="line">          <span class="attr">"language"</span>: <span class="string">"en_US"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"en_US"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>:  <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:   [ <span class="string">"lowercase"</span>, <span class="string">"en_US"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze?analyzer=en_US</span><br><span class="line">reorganizes</span><br><span class="line"></span><br><span class="line">GET /_analyze?analyzer=english</span><br><span class="line">reorganizes</span><br></pre></td></tr></table></figure>

<h5 id="Hunspell-词典格式"><a href="#Hunspell-词典格式" class="headerlink" title="Hunspell 词典格式"></a>Hunspell 词典格式</h5><h3 id="选择一个词干提取器"><a href="#选择一个词干提取器" class="headerlink" title="选择一个词干提取器"></a>选择一个词干提取器</h3><p>英语词干提取器：</p>
<ul>
<li>english: porter_stem​ 语汇单元过滤器（token filter）。</li>
<li>light_english : kstem 语汇单元过滤器（token filter）。</li>
<li>minimal_english : Lucene 里面的 EnglishMinimalStemmer ，用来移除复数。</li>
<li>lovins : 基于 Snowball 的 Lovins 提取器, 第一个词干提取器。</li>
<li>porter : 基于 Snowball 的 Porter 提取器。</li>
<li>porter2 : 基于 Snowball 的 Porter2 提取器。</li>
<li>possessive_english : Lucene 里面的 EnglishPossessiveFilter ，移除 ‘s</li>
<li>Hunspell : 基于词典的提取器</li>
</ul>
<p>词干提取问题：弱提取，过度提取</p>
<p>考虑词干提取器3个因素：</p>
<ul>
<li>性能：例如：算法提取器一般来说比 Hunspell 提取器快4到5倍。</li>
<li>质量：提取器各有优缺点，词典提取器取决于词典好坏，对词典中没有的词无法识别，可以精确识别不规则词语；算法提取器优点：性能好，可以识别新词，但无法精确识别不规则词语。</li>
<li>程度：不同的词干提取器会将词弱提取或过度提取到一定的程度。需要什么程度的提取要取决你的场景。比如：聚类算法需要提前力度更大点，匹配更广泛一点；面向最终用户，轻量提取会产生更好结果；文档大小，文档小力度大些，匹配的文档会多，反之文档大轻量的弱提取，匹配更准确。</li>
</ul>
<h3 id="控制词干提取"><a href="#控制词干提取" class="headerlink" title="控制词干提取"></a>控制词干提取</h3><ul>
<li>通过 keyword_marker和stemmer_override 自定义词干提取过程</li>
</ul>
<h5 id="阻止词干提取"><a href="#阻止词干提取" class="headerlink" title="阻止词干提取"></a>阻止词干提取</h5><p>两种方法：</p>
<ol>
<li>语言分析器中 <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/configuring-language-analyzers.html#stem-exclusion" target="_blank" rel="noopener">stem_exclusion</a> 指定词语列表，让他们不被词干提取。</li>
<li>语言分析器使用 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/analysis-keyword-marker-tokenfilter.html" target="_blank" rel="noopener">keyword_marker 语汇单元过滤器</a> 来标记这些词语列表为 keywords ，用来阻止后续的词干提取过滤器来触碰这些词语。</li>
</ol>
<p>配置keyword_marker</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">UT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"no_stem"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword_marker"</span>,</span><br><span class="line">          <span class="attr">"keywords"</span>: [ <span class="string">"skies"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_english"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"no_stem"</span>,</span><br><span class="line">            <span class="string">"porter_stem"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>keywords_path 参数允许我们将所有的关键字存在一个文件。 这个文件应该是每行一个字，并且存在于集群的每个节点。</p>
<p>使用 analyze API 来测试</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze?analyzer=my_english</span><br><span class="line">sky skies skiing skis</span><br></pre></td></tr></table></figure>

<h5 id="自定义提取"><a href="#自定义提取" class="headerlink" title="自定义提取"></a>自定义提取</h5><p>使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/analysis-stemmer-override-tokenfilter.html" target="_blank" rel="noopener">stemmer_override</a> 语汇单元过滤器允许我们指定自定义的提取规则。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"custom_stem"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"stemmer_override"</span>,</span><br><span class="line">          <span class="attr">"rules"</span>: [</span><br><span class="line">            <span class="string">"skies=&gt;sky"</span>,</span><br><span class="line">            <span class="string">"mice=&gt;mouse"</span>,</span><br><span class="line">            <span class="string">"feet=&gt;foot"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_english"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"custom_stem"</span>,</span><br><span class="line">            <span class="string">"porter_stem"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my_index/_analyze?analyzer=my_english</span><br><span class="line">The mice came down from the skies and ran over my feet</span><br></pre></td></tr></table></figure>
<ul>
<li>rules 规则来自 original=&gt;stem 。</li>
<li>custom_stem : stemmer_override 过滤器必须放置在词干提取器之前。</li>
<li>规则可以被存放在一个文件中，参数 rules_path来指定位置。</li>
</ul>
<h3 id="原形词干提取"><a href="#原形词干提取" class="headerlink" title="原形词干提取"></a>原形词干提取</h3><p>如何将已提取词干的词和原词索引到同一个字段中。</p>
<ol>
<li>使用keyword_repeat过滤器提去词干的原形词</li>
<li>使用unique 语汇单元过滤器 去除重复原形词</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"unique_stem"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"unique"</span>,</span><br><span class="line">          <span class="attr">"only_on_same_position"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"in_situ"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"keyword_repeat"</span>,</span><br><span class="line">            <span class="string">"porter_stem"</span>,</span><br><span class="line">            <span class="string">"unique_stem"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Pos 1: (the)</span><br><span class="line">Pos 2: (quick)</span><br><span class="line">Pos 3: (foxes,fox)</span><br><span class="line">Pos 4: (jumped,jump)</span><br></pre></td></tr></table></figure>

<ul>
<li>设置 unique 类型语汇单元过滤器，是为了只有当重复语汇单元出现在相同位置时，移除它们。</li>
<li>语汇单元过滤器必须出现在词干提取器之前。</li>
<li>unique_stem 过滤器是在词干提取器完成之后移除重复词项。</li>
</ul>
<h5 id="原形词干提取是个好主意吗"><a href="#原形词干提取是个好主意吗" class="headerlink" title="原形词干提取是个好主意吗"></a>原形词干提取是个好主意吗</h5><p>答案：原形词干提取不是个好主意。原因有两个：</p>
<ol>
<li>无法区分精准匹配和非精准匹配。</li>
<li>与提取词干的形式相比，降低了的IDF值。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/25-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%90%8C%E4%B9%89%E8%AF%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/25-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%90%8C%E4%B9%89%E8%AF%8D/" class="post-title-link" itemprop="url">03-处理人类语言-同义词</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-13 10:25:57" itemprop="dateCreated datePublished" datetime="2020-03-13T10:25:57+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:51" itemprop="dateModified" datetime="2020-05-26T13:53:51+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a></p>
<h3 id="同义词-Synonyms"><a href="#同义词-Synonyms" class="headerlink" title="同义词(Synonyms)"></a>同义词(Synonyms)</h3><ul>
<li>词干提取是通过简化他们的词根形式来扩大搜索的范围，同义词 通过相关的观念和概念来扩大搜索范围。</li>
<li>同义词也应该只在必要的时候使用,大规模使用同义词会导致查询结果趋向于让人觉得是随机的.</li>
<li>同义词似乎是一个简单的概念，但是正确的使用它们却是非常困难的。</li>
<li>同义词的字段不应该被单独使用，而应该与一个针对主字段的查询操作一起使用，这个主字段应该包含纯净格式的原始文本。</li>
</ul>
<h3 id="使用同义词-Using-Synonyms"><a href="#使用同义词-Using-Synonyms" class="headerlink" title="使用同义词(Using Synonyms)"></a>使用同义词(Using Synonyms)</h3><ul>
<li>同义词替换 使用同义词过滤器<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/analysis-synonym-tokenfilter.html" target="_blank" rel="noopener">synonym token filter</a></li>
<li>同义词可以使用synonyms或synonyms_path 指定</li>
<li>在索引和搜索中使用相同的同义词语汇单元过滤器是多余的。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_synonym_filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"synonym"</span>,</span><br><span class="line">          <span class="attr">"synonyms"</span>: [</span><br><span class="line">            <span class="string">"british,english"</span>,</span><br><span class="line">            <span class="string">"queen,monarch"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_synonyms"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"my_synonym_filter"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用analyze API 来测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;my_index&#x2F;_analyze?analyzer&#x3D;my_synonyms</span><br><span class="line">Elizabeth is the English queen</span><br><span class="line"></span><br><span class="line">Pos 1: (elizabeth)</span><br><span class="line">Pos 2: (is)</span><br><span class="line">Pos 3: (the)</span><br><span class="line">Pos 4: (british,english)</span><br><span class="line">Pos 5: (queen,monarch)</span><br></pre></td></tr></table></figure>

<h3 id="同义词格式-Formatting-Synonyms"><a href="#同义词格式-Formatting-Synonyms" class="headerlink" title="同义词格式(Formatting Synonyms)"></a>同义词格式(Formatting Synonyms)</h3><p>同义词表达式两种形式：</p>
<ol>
<li>用逗号分割，例如：”jump,leap,hop”</li>
<li>用=&gt; 表示，例如： “u s a,united states,united states of america =&gt; usa”</li>
</ol>
<p>匹配规则：如果多个规则指定同一个同义词，它们将被合并在一起，且顺序无关，否则使用最长匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;united states            &#x3D;&gt; usa&quot;,</span><br><span class="line">&quot;united states of america &#x3D;&gt; usa&quot;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果规则冲突 ，<code>united states of america</code>转换为<code>usa</code> <code>of</code> <code>america</code></li>
<li>如果规则不冲突，<code>united states of america</code>转换为<code>usa</code></li>
</ol>
<h3 id="扩展或收缩-Expand-or-contract"><a href="#扩展或收缩-Expand-or-contract" class="headerlink" title="扩展或收缩(Expand or contract)"></a>扩展或收缩(Expand or contract)</h3><p>通过 简单扩展 、 简单收缩 、或 类型扩展 来指明同义词规则.<br>本节对三者进行比较。</p>
<h5 id="简单扩展-Simple-Expansion"><a href="#简单扩展-Simple-Expansion" class="headerlink" title="简单扩展(Simple Expansion)"></a>简单扩展(Simple Expansion)</h5><ul>
<li>简单扩展: 把同义词列表中的任意一个词扩展成同义词列表</li>
<li>简单扩展可以应用在索引或查询阶段</li>
</ul>
<table>
<thead>
<tr>
<th align="left">特点</th>
<th align="left">索引</th>
<th align="left">查询</th>
</tr>
</thead>
<tbody><tr>
<td align="left">索引的大小</td>
<td align="left">⬇︎ 大索引。因为所有的同义词都会被索引，所以索引的大小相对会变大一些。</td>
<td align="left">正常大小</td>
</tr>
<tr>
<td align="left">关联</td>
<td align="left">⬇︎ 所有同义词都有相同的 IDF，这意味着通用的词和较常用的词都拥有着相同的权重。</td>
<td align="left">每个同义词 IDF 都和原来一样。</td>
</tr>
<tr>
<td align="left">性能</td>
<td align="left">查询只需要找到查询字符串中指定单个词项。</td>
<td align="left">⬇︎ 对一个词项的查询重写来查找所有的同义词，这样会降低性能。</td>
</tr>
<tr>
<td align="left">灵活性</td>
<td align="left">⬇︎ 同义词规则不能改变现有的文件。对于有影响的新规则，现有的文件都要重建</td>
<td align="left">⬆︎ 同义词规则可以更新不需要索引文件。</td>
</tr>
</tbody></table>
<h5 id="简单收缩"><a href="#简单收缩" class="headerlink" title="简单收缩"></a>简单收缩</h5><ul>
<li>简单收缩 ，把左边的多个同义词映射到了右边的一个词。</li>
<li>它必须同时应用于索引和查询阶段，以确保查询词项映射到索引中存在的同一个值。<br>例如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;leap,hop &#x3D;&gt; jump&quot;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>优缺点：</p>
<ul>
<li>索引的大小 ： ⬆︎ 索引大小是正常的，因为只有单一词项被索引。</li>
<li>关联 ： ⬇︎ 所有词项的 IDF 是一样的，所以你不能区分比较常用的词、不常用的单词。</li>
<li>性能： ⬆︎ 查询只需要在索引中找到单词的出现。</li>
<li>灵活性 ：⬆︎ 新同义词可以添加到规则的左侧并在查询阶段使用。例如：添加’bound’后：<code>&quot;leap,hop,bound =&gt; jump&quot;</code>,修改一下兼容旧数据<code>&quot;leap,hop,bound =&gt; jump,bound&quot;</code>。你需要重建索引文件，恢复到上面的规则（leap,hop,bound =&gt; jump ）来获得查询单个词项的性能优势。</li>
</ul>
<h5 id="类型扩展"><a href="#类型扩展" class="headerlink" title="类型扩展"></a>类型扩展</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;cat    &#x3D;&gt; cat,pet&quot;,</span><br><span class="line">&quot;kitten &#x3D;&gt; kitten,cat,pet&quot;,</span><br><span class="line">&quot;dog    &#x3D;&gt; dog,pet&quot;</span><br><span class="line">&quot;puppy  &#x3D;&gt; puppy,dog,pet&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>类型扩展：扩大了词的意义，使被拓展的词更为通用。</li>
<li>类型扩展在索引阶段使用，例如：查询一个 cat 会找到关于 kittens 和 cats 的文档。</li>
<li>类型扩展在查询阶段使用，例如：kitten 的查询结果就会被拓展成涉及到 kittens、cats、dogs。</li>
<li>索引阶段应用类型扩展，查询阶段不采用同义词。</li>
</ul>
<h3 id="同义词和分析链"><a href="#同义词和分析链" class="headerlink" title="同义词和分析链"></a>同义词和分析链</h3><p>分析链如下： standard tokenizer –&gt; lowercase token filter –&gt; synonym token filter<br>例如’U.S.A’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">original string（原始文本）                       → &quot;U.S.A.&quot;</span><br><span class="line">standard           tokenizer（分词器）            → (U),(S),(A)</span><br><span class="line">lowercase          token filter（语汇单元过滤器）  → (u),(s),(a)</span><br><span class="line">synonym            token filter（语汇单元过滤器）  → (usa)</span><br></pre></td></tr></table></figure>
<p>将同义词过滤器放置在词根过滤器之后更简洁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;leap &#x3D;&gt; jump&quot;</span><br></pre></td></tr></table></figure>

<h5 id="大小写敏感的同义词"><a href="#大小写敏感的同义词" class="headerlink" title="大小写敏感的同义词"></a>大小写敏感的同义词</h5><p>对应对大小写敏感的同义词，定义特定的同义词规则。<br>大小写敏感的规则：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"CAT,CAT scan           =&gt; cat_scan"</span></span><br><span class="line"><span class="string">"PET,PET scan           =&gt; pet_scan"</span></span><br><span class="line"><span class="string">"Johnny Little,J Little =&gt; johnny_little"</span></span><br><span class="line"><span class="string">"Johnny Small,J Small   =&gt; johnny_small"</span></span><br></pre></td></tr></table></figure>
<p>大小写不敏感的规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;cat                    &#x3D;&gt; cat,pet&quot;</span><br><span class="line">&quot;dog                    &#x3D;&gt; dog,pet&quot;</span><br><span class="line">&quot;cat scan,cat_scan scan &#x3D;&gt; cat_scan&quot;</span><br><span class="line">&quot;pet scan,pet_scan scan &#x3D;&gt; pet_scan&quot;</span><br><span class="line">&quot;little,small&quot;</span><br></pre></td></tr></table></figure>

<h3 id="多词同义词和短语查询"><a href="#多词同义词和短语查询" class="headerlink" title="多词同义词和短语查询"></a>多词同义词和短语查询</h3><p>多词同义词会严重破坏词的位置信息，尤其当新增的同义词标记长度各不相同的时候。</p>
<h5 id="使用简单收缩进行短语查询"><a href="#使用简单收缩进行短语查询" class="headerlink" title="使用简单收缩进行短语查询"></a>使用简单收缩进行短语查询</h5><p>使用简单收缩，把多个同义词用单个词表示，查询时需要针对单个词查询</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_synonym_filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"synonym"</span>,</span><br><span class="line">          <span class="attr">"synonyms"</span>: [</span><br><span class="line">            <span class="string">"united states,u s a,united states of america=&gt;usa"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_synonyms"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"my_synonym_filter"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my_index/_analyze?analyzer=my_synonyms</span><br><span class="line">The United States is wealthy</span><br></pre></td></tr></table></figure>
<h5 id="同义词与query-string查询"><a href="#同义词与query-string查询" class="headerlink" title="同义词与query_string查询"></a>同义词与query_string查询</h5><p>本书很少谈论到 query_string 查询，因为真心不推荐你用它。</p>
<h3 id="符号同义词"><a href="#符号同义词" class="headerlink" title="符号同义词"></a>符号同义词</h3><ul>
<li>符号同义词是用别名来表示这个符号，以防止它在分词过程中被误认为是不重要的标点符号而被移除。</li>
<li>怎么处理符号同义词？分词之前替换符号成单词。</li>
<li>映射mapping 字符过滤器是个非常有用的过滤器，它可以用来对一些已有的字词进行替换操作， 你如果想要采用更灵活的正则表达式去替换字词的话，那你可以使用 pattern_replace 字符过滤器。</li>
</ul>
<p>虽然绝大多数情况下，符号对于全文搜索而言都无关紧要，但是字符组合而成的表情，或许又会是很有意义的东西。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我很高兴能在星期天工作 :( （注：难过的表情）</span><br></pre></td></tr></table></figure>
<ol>
<li>先使用 映射字符过滤器</li>
<li>在文本被递交给分词器处理之前， 把字符表情替换成符号同义词 emoticon_happy 或者 emoticon_sad</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"char_filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"emoticons"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"mapping"</span>,</span><br><span class="line">          <span class="attr">"mappings"</span>: [</span><br><span class="line">            <span class="string">":)=&gt;emoticon_happy"</span>,</span><br><span class="line">            <span class="string">":(=&gt;emoticon_sad"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_emoticons"</span>: &#123;</span><br><span class="line">          <span class="attr">"char_filter"</span>: <span class="string">"emoticons"</span>,</span><br><span class="line">          <span class="attr">"tokenizer"</span>:   <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:    [ <span class="string">"lowercase"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my_index/_analyze?analyzer=my_emoticons</span><br><span class="line">I am :) not :(</span><br></pre></td></tr></table></figure>



<p>###</p>
<p>###</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/22-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%BD%92%E4%B8%80%E5%8C%96%E8%AF%8D%E5%85%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/22-%E5%A4%84%E7%90%86%E4%BA%BA%E7%B1%BB%E8%AF%AD%E8%A8%80-%E5%BD%92%E4%B8%80%E5%8C%96%E8%AF%8D%E5%85%83/" class="post-title-link" itemprop="url">03-处理人类语言-归一化词元</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-13 07:52:57" itemprop="dateCreated datePublished" datetime="2020-03-13T07:52:57+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:51" itemprop="dateModified" datetime="2020-05-26T13:53:51+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>###<br><a href="">中文参考</a>，<a href="">英文参考</a><br>参考地址：</p>
<ul>
<li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/token-normalization.html" target="_blank" rel="noopener">中文</a></li>
<li><a href="https://github.com/elastic/elasticsearch-definitive-guide/tree/master/220_Token_normalization" target="_blank" rel="noopener">英文</a></li>
</ul>
<h3 id="归一化词元-Normalizing-Tokens"><a href="#归一化词元-Normalizing-Tokens" class="headerlink" title="归一化词元(Normalizing Tokens)"></a>归一化词元(Normalizing Tokens)</h3><ul>
<li>归一化(normalization)目的：为了让词元(token)更容易搜索.</li>
<li>归一化(normalization)作用：归一化过程会去除同一个词元(token)的无意义或有意义的差别。例如：大小写，有声调的词</li>
<li>语汇单元过滤器(token filters)的工作 ：语汇单元过滤器(token filters)接受来自分词器(tokenizer)的词元(token)流，多个语汇单元过滤器会依次处理词元，每个过滤器都可以处理来自另一个过滤器输出的单词流。</li>
</ul>
<h3 id="举个例子-In-That-Case"><a href="#举个例子-In-That-Case" class="headerlink" title="举个例子 In That Case"></a>举个例子 In That Case</h3><p>lowercase过滤器是常用的 语汇单元过滤器(token filter),它把字母变小写。<br>例如：FOX转换为fox，存储到索引中，那FOX和fox在索引中对应的是同一个词元(token)</p>
<p>查看例子</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze?tokenizer=standard&amp;filters=lowercase</span><br><span class="line">The QUICK Brown FOX!</span><br></pre></td></tr></table></figure>
<p>自定义分析器(analyzer)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_lowercaser"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"lowercase"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze?analyzer=my_lowercaser</span><br><span class="line">The QUICK Brown FOX!</span><br></pre></td></tr></table></figure>

<h3 id="Removing-diacritics-如果有口音-You-Have-an-Accent"><a href="#Removing-diacritics-如果有口音-You-Have-an-Accent" class="headerlink" title="Removing_diacritics 如果有口音(You Have an Accent)"></a>Removing_diacritics 如果有口音(You Have an Accent)</h3><p>asciifolding filter作用：去掉变音符合并把Unicode字符转化为ASCII。</p>
<p>定义</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"folding"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"lowercase"</span>, <span class="string">"asciifolding"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my_index?analyzer=folding</span><br><span class="line">My œsophagus caused a débâcle</span><br></pre></td></tr></table></figure>
<h5 id="保留原意-Retaining-Meaning"><a href="#保留原意-Retaining-Meaning" class="headerlink" title="保留原意(Retaining Meaning)"></a>保留原意(Retaining Meaning)</h5><p>使用多次索引，一次索引保留变音符，一次索引去除变音符。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping/my_type</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"title"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>:           <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"analyzer"</span>:       <span class="string">"standard"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: &#123;</span><br><span class="line">        <span class="attr">"folded"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>:   <span class="string">"folding"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>:     <span class="string">"most_fields"</span>,</span><br><span class="line">      <span class="attr">"query"</span>:    <span class="string">"esta loca"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"title.folded"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用validate-query API查看执行情况。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>:     <span class="string">"most_fields"</span>,</span><br><span class="line">      <span class="attr">"query"</span>:    <span class="string">"está loca"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"title.folded"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unicode的世界-Living-in-a-Unicode-World"><a href="#Unicode的世界-Living-in-a-Unicode-World" class="headerlink" title="Unicode的世界(Living in a Unicode World)"></a>Unicode的世界(Living in a Unicode World)</h3><p>遇到的问题：相同的单词使用了不同的编码，ES的词元(token)比较是在字节(byte)级别进行比较，Unicode中相同的字符可以用不同的字节表示。<br>解决方法：使用Unicode 归一化(Unicode normalization), 把Unicode字符转换成对应标准格式，把所有的字符进行字节(byte)级别的比较。</p>
<p>4种Unicode归一化形式：nfc,nfd,nfkc,nfkd<br>组合模式：</p>
<ol>
<li>组合形式(composed forms) : <code>nfc</code>和<code>nfkc</code>,用尽可能少的字节(byte)来代表字符. 用 <code>é</code> 来代表单个字母 <code>é</code> 。  </li>
<li>分解模式(decomposed forms）: <code>nfd</code> and <code>nfkd</code>, 用字符的每一部分来代表字符。所以 <code>é</code> 分解为 <code>e</code> 和 <code>´</code>。</li>
<li>规范模式(canonical forms) ：<code>nfc</code>和<code>nfd</code>,把连字作为单个字符。</li>
<li>兼容模式(compatibility forms): <code>nfkc</code>和<code>nfkd</code>，将这些组合的字符分解成简单字符的等价物，例如：f+f+i 或o+e</li>
</ol>
<p>无论选择哪一种模式，只要你的文本只用一种模式，那你的同一词元就会由相同的字节组成。</p>
<p>你可以使用 icu_normalizer 语汇单元过滤器(token filters) 来保证你的所有词元(token)是相同模式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"nfkc_normalizer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"icu_normalizer"</span>,</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"nfkc"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_normalizer"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"icu_tokenizer"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"nfkc_normalizer"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unicode-大小写折叠-Unicode-Case-Folding"><a href="#Unicode-大小写折叠-Unicode-Case-Folding" class="headerlink" title="Unicode 大小写折叠(Unicode Case Folding)"></a>Unicode 大小写折叠(Unicode Case Folding)</h3><p>在unicode中大小写折叠 (Case folding) 把单词转换到一种(通常是小写)形式，是让写法不会影响单词的比较，所以拼写不需要完全正确.<br>Unicode 大小写折叠适合所有的语言，而lowercasing则不行。</p>
<p>例如：德语小写单词 ß -变大写-&gt; SS , ß–变小写-&gt;ss</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_lowercaser"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"icu_tokenizer"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"icu_normalizer"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>icu_normalizer 默认是 nfkc_cf 模式.</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze?analyzer=standard</span><br><span class="line">Weißkopfseeadler WEISSKOPFSEEADLER</span><br><span class="line"></span><br><span class="line">GET /my_index/_analyze?analyzer=my_lowercaser</span><br><span class="line">Weißkopfseeadler WEISSKOPFSEEADLER</span><br></pre></td></tr></table></figure>
<ul>
<li>得到的词元(token)是 weißkopfseeadler, weisskopfseeadler</li>
<li>得到的词元(token)是 weisskopfseeadler, weisskopfseeadler</li>
<li><code>standard</code>分析器得到了两个不同且不可比较的词元(token)，而我们定制化的分析器得到了两个相同但是不符合原意的词元(token)。</li>
</ul>
<h3 id="Unicode-字符折叠"><a href="#Unicode-字符折叠" class="headerlink" title="Unicode 字符折叠"></a>Unicode 字符折叠</h3><p>Unicode character-folding可以有效地处理世界各种语言。<br><code>icu_folding</code> token filters的功能和 <code>asciifolding</code> 过滤器一样，但是它扩展到了非ASCII编码的语言，它把这些语言都转换对应拉丁文字，甚至包含它们的各种各样的计数符号，象形符号和标点符号。例如：希腊语，希伯来语，汉语。<br><code>icu_folding</code> 语汇单元过滤器(token filters)自动使用 <code>nfkc_cf</code> 模式来进行大小写折叠和Unicode归一化(normalization)，所以不需要使用 <code>icu_normalizer</code> ：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_folder"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"icu_tokenizer"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"icu_folding"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>阿拉伯数字 ١٢٣٤٥ 被折叠成等价的拉丁数字: 12345.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze?analyzer=my_folder</span><br><span class="line">١٢٣٤٥</span><br></pre></td></tr></table></figure>

<p>指定那些unicode不被折叠，例如[^åäöÅÄÖ] (^ 表示 不包含)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"swedish_folding"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"icu_folding"</span>,</span><br><span class="line">          <span class="attr">"unicodeSetFilter"</span>: <span class="string">"[^åäöÅÄÖ]"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"swedish_analyzer"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"icu_tokenizer"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>:  [ <span class="string">"swedish_folding"</span>, <span class="string">"lowercase"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="排序和整理-Sorting-and-Collations"><a href="#排序和整理-Sorting-and-Collations" class="headerlink" title="排序和整理(Sorting and Collations)"></a>排序和整理(Sorting and Collations)</h3><p>多语言排序会面临很多问题，语言之间的差别，每个语言排序不同。</p>
<h5 id="unicode-归类算法-Unicode-Collation-Algorithm"><a href="#unicode-归类算法-Unicode-Collation-Algorithm" class="headerlink" title="unicode 归类算法(Unicode Collation Algorithm)"></a>unicode 归类算法(Unicode Collation Algorithm)</h5><ul>
<li>Unicode归类将文本按照定义好顺序进行排序的过程。</li>
<li>Unicode归类算法(Unicode Collation Algorithm 简称UCA) ，UCA 定义了一种将字符串按照在归类单元表中定义的顺序排序的方法（通常称为排序规则）。</li>
<li>UCA 还定义了 默认 Unicode 排序规则元素表(Default Unicode Collation Element Table，简称 DUCET) 。</li>
<li>DUCET 为无论任何语言的所有 Unicode 字符定义了默认排序。每种语言都有自己的排序规则，大多时候用DUCET作为起点并添加一些自定义规则。</li>
</ul>
<p>icu_collation token filter默认使用DUCET排序规则。<br>定义unicode排序规则</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"ducet_sort"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [ <span class="string">"icu_collation"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用多字段进行多次索引</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping/user</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: &#123;</span><br><span class="line">        <span class="attr">"sort"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>: <span class="string">"ducet_sort"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询name.sort</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/user/_search?sort=name.sort</span><br></pre></td></tr></table></figure>

<h5 id="指定语言"><a href="#指定语言" class="headerlink" title="指定语言"></a>指定语言</h5><p>icu_collation指定语言<br>PUT /my_index<br>{<br>  “settings”: {<br>    “number_of_shards”: 1,<br>    “analysis”: {<br>      “filter”: {<br>        “german_phonebook”: {<br>          “type”:     “icu_collation”,<br>          “language”: “de”,<br>          “country”:  “DE”,<br>          “variant”:  “@collation=phonebook”<br>        }<br>      },<br>      “analyzer”: {<br>        “german_phonebook”: {<br>          “tokenizer”: “keyword”,<br>          “filter”:  [ “german_phonebook” ]<br>        }<br>      }<br>    }<br>  },<br>  “mappings”: {<br>    “user”: {<br>      “properties”: {<br>        “name”: {<br>          “type”: “string”,<br>          “fields”: {<br>            “sort”: {<br>              “type”:     “string”,<br>              “analyzer”: “german_phonebook”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h5 id="多排序规则"><a href="#多排序规则" class="headerlink" title="多排序规则"></a>多排序规则</h5><p>使用多字段进行多次索引，每个字段对应一个语言。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping/_user</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: &#123;</span><br><span class="line">        <span class="attr">"default"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>: <span class="string">"ducet"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"french"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>: <span class="string">"french"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"german"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>: <span class="string">"german_phonebook"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"swedish"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:     <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>: <span class="string">"swedish"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="自定义排序"><a href="#自定义排序" class="headerlink" title="自定义排序"></a>自定义排序</h5><p>icu_collation分词过滤器可以提供很多选项</p>
<ol>
<li>定制排序算法：language、country、varinat</li>
<li>忽略变音符号</li>
<li>顺序大写排先或排后，或忽略大小写</li>
<li>考虑或忽略标点符号和空白</li>
<li>将数字按照字符串或数字值排序</li>
<li>自定义现有归类或定义自己的归类</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/12/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/19-%E6%B7%B1%E5%85%A5%E6%90%9C%E7%B4%A2-%E6%8E%A7%E5%88%B6%E7%9B%B8%E5%85%B3%E5%BA%A62/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/12/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/19-%E6%B7%B1%E5%85%A5%E6%90%9C%E7%B4%A2-%E6%8E%A7%E5%88%B6%E7%9B%B8%E5%85%B3%E5%BA%A62/" class="post-title-link" itemprop="url">19-深入搜索-控制相关度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-12 09:52:57" itemprop="dateCreated datePublished" datetime="2020-03-12T09:52:57+08:00">2020-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:30" itemprop="dateModified" datetime="2020-05-26T13:53:30+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a></p>
<h3 id="function-score-查询"><a href="#function-score-查询" class="headerlink" title="function_score 查询"></a>function_score 查询</h3><ul>
<li>过滤器无法计算评分。这样就需要寻求一种方式将过滤器和查询间的差异抹平。function_score 查询不仅正好可以扮演这个角色，而且有更强大的功能。</li>
<li>function_score 查询允许每个与主查询匹配的文档应用一个函数，以达到改变甚至替换原始查询评分的目的。</li>
<li>function_score 可以使用过滤器，这样既可以高效评分，有能利用过滤器缓存</li>
<li>function_score可以将全文查询与最新发生的因子结合在一起评分，可以根据全文相关度进行排序，但也会同时考虑其他因子：新发布文档、流行文档、或接近用户希望价格的产品等。</li>
</ul>
<p>ES预定义的函数：</p>
<ul>
<li>weight : 为每个文档应用一个权重提升值，该值不会被归一化，当weight=2时，最终结果为 2 * <code>_score</code></li>
<li>field_value_factor : 使用这个值来修改 <code>_score</code> ，如将 popularity 或 votes （受欢迎或赞）作为考虑因素。</li>
<li>random_score : 为每个用户都使用一个不同的随机评分对结果排序，但对某一具体用户来说，看到的顺序始终是一致的。</li>
<li>衰减函数 —— linear、 exp、 gauss : 将浮动值结合到评分 <code>_score</code> 中，例如结合 publish_date 获得最近发布的文档，结合 geo_location 获得更接近某个具体经纬度（lat/lon）地点的文档，结合 price 获得更接近某个特定价格的文档。</li>
<li>script_score : 如果需求超出以上范围时，用自定义脚本可以完全控制评分计算，实现所需逻辑。</li>
</ul>
<h3 id="按受欢迎度提升权重-Boosting-by-Popularity"><a href="#按受欢迎度提升权重-Boosting-by-Popularity" class="headerlink" title="按受欢迎度提升权重(Boosting by Popularity)"></a>按受欢迎度提升权重(Boosting by Popularity)</h3><p>将 function_score 查询与 field_value_factor 结合使用，即将点赞数与全文相关度评分结合。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /blogposts/post/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:    <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span>,</span><br><span class="line">        <span class="attr">"factor"</span>:   <span class="number">0.1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"boost_mode"</span>: <span class="string">"sum"</span>,</span><br><span class="line">      <span class="attr">"max_boost"</span>:  <span class="number">1.5</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面配置后的公式： <code>new_score = old_score + log(1 + 0.1 * number_of_votes)</code><br>max_boost限制结果，无论 field_value_factor 函数的结果如何，最终结果都不会大于 1.5 。</p>
<p>参数说明：</p>
<ul>
<li>function_score 查询将主查询和函数包括在内。</li>
<li>主查询query优先执行。</li>
<li>field_value_factor 函数会被应用到每个与主 query 匹配的文档。</li>
<li>每个文档的 votes 字段都 必须 有值供 function_score 计算。如果 没有 文档的 votes 字段有值，那么就 必须 使用 missing 属性 提供的默认值来进行评分计算。</li>
<li>modifier调节器 取值：none(默认)，log,log1p,log2p,ln,ln1p,ln2p,square,sqrt,reciprocal；更多参考:  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl-function-score-query.html#function-field-value-factor" target="_blank" rel="noopener">field_value_factor 文档</a></li>
<li>factor : 协调因子，factor 值大于 1 会提升效果， factor 值小于 1 会降低效果。例如：new_score = old_score * log(1 + factor * number_of_votes)</li>
<li>max_boost : 限制一个函数的最大效果，max_boost 只对函数的结果进行限制，不会对最终评分<code>_score</code>产生直接影响。</li>
<li>boost_mode : 控制函数与查询评分(<code>_score</code>)合并后的结果。取值如下：<ul>
<li>multiply : 评分 <code>_score</code> 与函数值的积（默认）</li>
<li>sum : 评分 <code>_score</code>与函数值的和</li>
<li>min : 评分 <code>_score</code>与函数值间的较小值</li>
<li>max : 评分 <code>_score</code>与函数值间的较大值</li>
<li>replace : 函数值替代评分<code>_score</code></li>
</ul>
</li>
</ul>
<h3 id="过滤集提升权重"><a href="#过滤集提升权重" class="headerlink" title="过滤集提升权重"></a>过滤集提升权重</h3><p>查询city 字段中包含 Barcelona 的所有文档，不需要全文检索，用过滤比用查询表达更清晰。<br>使用filter(不是query)和weight提升权重，weight没有被归一化，而是直接被应用。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;  </span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123; <span class="attr">"city"</span>: <span class="string">"Barcelona"</span> &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"functions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"features"</span>: <span class="string">"wifi"</span> &#125;&#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"features"</span>: <span class="string">"garden"</span> &#125;&#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"features"</span>: <span class="string">"pool"</span> &#125;&#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"score_mode"</span>: <span class="string">"sum"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>function_score 查询有个 filter 过滤器而不是 query 查询。</li>
<li>functions 关键字下存储着一个函数列表，每个函数都指定一个 filter 过滤器。</li>
<li>函数会被应用于filter过滤器匹配的文档。</li>
<li>score_mode 指定各个函数的值进行组合运算的方式。</li>
<li>function_score 取值： match_all(默认)，query，filter。</li>
<li>score_mode评分模式 ：将多个函数(filter)返回的结果缩减为单个值的方式。<ul>
<li>multiply : 函数结果求积（默认）。</li>
<li>sum : 函数结果求和。</li>
<li>avg : 函数结果的平均值。</li>
<li>max : 函数结果的最大值。</li>
<li>min : 函数结果的最小值。</li>
<li>first : 使用首个函数（可以有过滤器，也可能没有）的结果作为最终结果</li>
</ul>
</li>
<li>在本例中，将每个过滤器匹配结果的权重 weight 求和，并将其作为最终评分结果，所以会使用sum评分模式。</li>
<li>不与任何过滤器匹配的文档会保有其原始评分， <code>_score</code> 值的为 1 。</li>
</ul>
<h3 id="随机评分"><a href="#随机评分" class="headerlink" title="随机评分"></a>随机评分</h3><ul>
<li>一致随机评分（consistently random scoring）,当seed相同时产生的随机数始终一致。</li>
<li>使用场景：很多文档评分相同，使用每个文档都有均等相似的展现率</li>
<li>random_score 函数会输出一个 0 到 1 之间的数，当种子 seed 值相同时，生成的随机结果是一致的</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123; <span class="attr">"city"</span>: <span class="string">"Barcelona"</span> &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"functions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"features"</span>: <span class="string">"wifi"</span> &#125;&#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"features"</span>: <span class="string">"garden"</span> &#125;&#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"features"</span>: <span class="string">"pool"</span> &#125;&#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"random_score"</span>: &#123;</span><br><span class="line">            <span class="attr">"seed"</span>:  <span class="string">"the users session id"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"score_mode"</span>: <span class="string">"sum"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>random_score 语句没有任何过滤器 filter ，所以会被应用到所有文档。</li>
<li>将用户的会话 ID 作为种子 seed ，让该用户的随机始终保持一致，相同的种子 seed 会产生相同的随机结果。</li>
</ul>
<h3 id="越近越好"><a href="#越近越好" class="headerlink" title="越近越好"></a>越近越好</h3><p>function_score提供一组 衰减函数(decay functions) ： linear(线性)、exp(指数)、gauss(高斯函数)；</p>
<p>三个函数都能接受的参数：</p>
<ul>
<li>origin : 中心点 或 字段可能的最佳值，落在原点 origin 上的文档评分 <code>_score</code> 为满分 1.0 。</li>
<li>scale : 衰减率，即一个文档从原点origin下落时评分<code>_score</code>改变的速度。(例如：每100元或 每100米)</li>
<li>decay : 从原点origin衰减到scale所得的评分<code>_score</code>,默认值是 0.5</li>
<li>offset : 以原点 origin 为中心点，为其设置一个非零的偏移量 offset 覆盖一个范围，而不只是单个原点。在范围 -offset &lt;= origin &lt;= +offset 内的所有评分 <code>_score</code> 都是 1.0 。</li>
</ul>
<p>三个函数之间的区别在于范围（ origin +/- (offset + scale) ）之外的曲线形状：</p>
<ul>
<li>linear 线性函数是条直线，一旦直线与横轴 0 相交，所有其他值的评分都是 0.0 。</li>
<li>exp 指数函数是先剧烈衰减然后变缓。</li>
<li>gauss 高斯函数是钟形的——它的衰减速率是先缓慢，然后变快，最后又放缓。</li>
</ul>
<p>以伦敦市中作为原点 origin 。<br>所有距原点 origin 2km 范围内的位置的评分是 1.0 。<br>距中心 5km （ offset + scale ）的位置的评分是 0.5 。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"functions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"gauss"</span>: &#123;</span><br><span class="line">            <span class="attr">"location"</span>: &#123;</span><br><span class="line">              <span class="attr">"origin"</span>: &#123; <span class="attr">"lat"</span>: <span class="number">51.5</span>, <span class="attr">"lon"</span>: <span class="number">0.12</span> &#125;,</span><br><span class="line">              <span class="attr">"offset"</span>: <span class="string">"2km"</span>,</span><br><span class="line">              <span class="attr">"scale"</span>:  <span class="string">"3km"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"gauss"</span>: &#123;</span><br><span class="line">            <span class="attr">"price"</span>: &#123;</span><br><span class="line">              <span class="attr">"origin"</span>: <span class="string">"50"</span>,</span><br><span class="line">              <span class="attr">"offset"</span>: <span class="string">"50"</span>,</span><br><span class="line">              <span class="attr">"scale"</span>:  <span class="string">"20"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"weight"</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="理解-price-价格语句"><a href="#理解-price-价格语句" class="headerlink" title="理解 price 价格语句"></a>理解 price 价格语句</h3><p>price小技巧: 用户希望选择100元以下的度假屋，把原点origin设置为50，偏移量offset设置为50，这样就能覆盖 0-100元的范围了。</p>
<h3 id="脚本评分"><a href="#脚本评分" class="headerlink" title="脚本评分"></a>脚本评分</h3><p>如果function_score无法满足应用场景，可以使用script_score 函数自行实现逻辑。</p>
<p>Elasticsearch 里使用 Groovy 作为默认的脚本语言，它与JavaScript很像，上面这个算法用 Groovy 脚本表示如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">price  &#x3D; doc[&#39;price&#39;].value</span><br><span class="line">margin &#x3D; doc[&#39;margin&#39;].value</span><br><span class="line"></span><br><span class="line">if (price &lt; threshold) &#123;</span><br><span class="line">  return price * margin &#x2F; target</span><br><span class="line">&#125;</span><br><span class="line">return price * (1 - discount) * margin &#x2F; target</span><br></pre></td></tr></table></figure>

<p>最终script_score函数与其他函数一起使用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">    <span class="attr">"functions"</span>: [</span><br><span class="line">      &#123; ... 上面的gauss函数 location clause ... &#125;,</span><br><span class="line">      &#123; ... 上面的gauss函数 price clause ... &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"script_score"</span>: &#123;</span><br><span class="line">          <span class="attr">"params"</span>: &#123;</span><br><span class="line">            <span class="attr">"threshold"</span>: <span class="number">80</span>,</span><br><span class="line">            <span class="attr">"discount"</span>: <span class="number">0.1</span>,</span><br><span class="line">            <span class="attr">"target"</span>: <span class="number">10</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"script"</span>: <span class="string">"price  = doc['price'].value; margin = doc['margin'].value;</span></span><br><span class="line"><span class="string">          if (price &lt; threshold) &#123; return price * margin / target &#125;;</span></span><br><span class="line"><span class="string">          return price * (1 - discount) * margin / target;"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>location 和 price 语句在 衰减函数 中解释过。</li>
<li>将这些变量作为参数 params 传递，我们可以查询时动态改变脚本无须重新编译。</li>
<li>JSON 不能接受内嵌的换行符，脚本中的换行符可以用 \n 或 ; 符号替代。</li>
<li>script_score 函数提供了巨大的灵活性，可以通过脚本访问文档里的所有字段、当前评分 <code>_score</code> 甚至词频、逆向文档频率和字段长度规范值这样的信息</li>
<li>如果脚本执行慢，有下面方法优化：<ul>
<li>尽可能多的提前计算各种信息并将结果存入每个文档中。</li>
<li>Groovy 很快，但没 Java 快。可以将脚本用原生的 Java 脚本重新实现。（参见 原生 Java 脚本）。</li>
<li>仅对那些最佳评分的文档应用脚本，使用 重新评分 中提到的 rescore 功能。</li>
</ul>
</li>
</ul>
<h3 id="可插拔的相似度算法-Pluggable-Similarity-Algorithms"><a href="#可插拔的相似度算法-Pluggable-Similarity-Algorithms" class="headerlink" title="可插拔的相似度算法(Pluggable Similarity Algorithms)"></a>可插拔的相似度算法(Pluggable Similarity Algorithms)</h3><p>Elasticsearch 将 实用评分算法 作为默认相似度算法，它也能够支持其他的一些算法，这些算法可以参考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/index-modules-similarity.html#configuration" target="_blank" rel="noopener">相似度模块</a> 文档.</p>
<h5 id="Okapi-BM25"><a href="#Okapi-BM25" class="headerlink" title="Okapi BM25"></a>Okapi BM25</h5><p>能与 TF/IDF 和向量空间模型媲美的就是 Okapi BM25 ，它被认为是 当今最先进的 排序函数。 BM25 源自 概率相关模型（probabilistic relevance model） ，而不是向量空间模型，但这个算法也和 Lucene 的实用评分函数有很多共通之处。</p>
<p>BM25 同样使用词频、逆向文档频率以及字段长归一化，但是每个因子的定义都有细微区别。与其详细解释 BM25 公式，倒不如将关注点放在 BM25 所能带来的实际好处上。</p>
<p>参考 <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/pluggable-similarites.html#bm25-saturation" target="_blank" rel="noopener">Okapi BM25</a></p>
<h5 id="词频饱和度-Term-frequency-saturation"><a href="#词频饱和度-Term-frequency-saturation" class="headerlink" title="词频饱和度(Term-frequency saturation)"></a>词频饱和度(Term-frequency saturation)</h5><p>BM25的非线性词频饱和度（nonlinear term-frequency saturation），达到某值后即使词频一直增加但对评分的影响很小。</p>
<p>参考 <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/pluggable-similarites.html#bm25-saturation" target="_blank" rel="noopener">词频饱和度</a></p>
<h5 id="字段长度归一化-Field-length-normalization"><a href="#字段长度归一化-Field-length-normalization" class="headerlink" title="字段长度归一化(Field-length normalization)"></a>字段长度归一化(Field-length normalization)</h5><p>BM25会考虑字段的平均长度，这样能区分是短的title字段还是长的title字段。</p>
<h5 id="BM25-调优-Tuning-BM25"><a href="#BM25-调优-Tuning-BM25" class="headerlink" title="BM25 调优(Tuning BM25)"></a>BM25 调优(Tuning BM25)</h5><p>BM25有两个可调参数：</p>
<ul>
<li>k1 : 这个参数控制着词频结果在词频饱和度中的上升速度。默认值为 1.2 。值越小饱和度变化越快，值越大饱和度变化越慢。</li>
<li>b : 这个参数控制着字段长归一值所起的作用， 0.0 会禁用归一化， 1.0 会启用完全归一化。默认值为 0.75 。</li>
</ul>
<h3 id="更改相似度"><a href="#更改相似度" class="headerlink" title="更改相似度"></a>更改相似度</h3><ul>
<li>相似度算法可以在映射时指定到字段上</li>
<li>字段默认是 实用评分函数</li>
<li>ES不支持更改已有字段的相似度算法</li>
<li>自定义的相似度算法可以通过关闭索引，更新索引设置，开启索引这个过程进行更新。这样可以无须重建索引又能试验不同的相似度算法配置。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"similarity"</span>: <span class="string">"BM25"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"body"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"similarity"</span>: <span class="string">"default"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义相似度算法</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"similarity"</span>: &#123;</span><br><span class="line">      <span class="attr">"my_bm25"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"BM25"</span>,</span><br><span class="line">        <span class="attr">"b"</span>:    <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"similarity"</span>: <span class="string">"my_bm25"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"body"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:       <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"similarity"</span>: <span class="string">"BM25"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个基于内置 BM25 ，名为 my_bm25 的自定义相似度算法。</li>
<li>“b”:0  禁用字段长度规范化（field-length normalization）。参见 调试 BM25 。</li>
<li>title 字段使用自定义相似度算法 my_bm25 。</li>
<li>字段 body 使用内置相似度算法 BM25</li>
</ul>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><h3 id="调试相关度是最后-10-要做的事情-Relevance-Tuning-Is-the-Last-10"><a href="#调试相关度是最后-10-要做的事情-Relevance-Tuning-Is-the-Last-10" class="headerlink" title="调试相关度是最后 10% 要做的事情(Relevance Tuning Is the Last 10%)"></a>调试相关度是最后 10% 要做的事情(Relevance Tuning Is the Last 10%)</h3><ul>
<li>本章介绍了 Lucene 是如何基于 TF/IDF 生成评分的</li>
<li>理解评分过程是非常重要的，这样就可以根据具体的业务对评分结果进行调试、调节、减弱和定制。</li>
<li>最佳实践：为了获得 具有成效 的搜索结果，就必须反复调试、调节、减弱和定制。</li>
<li>经过对策略字段或重要语句应用权重提升。</li>
<li>因为最相关 这个概念是一个难以触及的模糊目标，通常不同人对文档排序又有着不同的想法，容易使人陷入持续反复调整而没有明显进展的怪圈。不用陷入怪圈，要监控测量返回的结果，例如:监控顶端结果的点击次数，来回查看的频次。</li>
<li>要想物尽其用并将搜索结果提高到 极高的 水平，唯一途径就是需要具备能评价度量用户行为的强大能力</li>
</ul>
<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/11/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/18-%E6%B7%B1%E5%85%A5%E6%90%9C%E7%B4%A2-%E6%8E%A7%E5%88%B6%E7%9B%B8%E5%85%B3%E5%BA%A61/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/11/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/18-%E6%B7%B1%E5%85%A5%E6%90%9C%E7%B4%A2-%E6%8E%A7%E5%88%B6%E7%9B%B8%E5%85%B3%E5%BA%A61/" class="post-title-link" itemprop="url">18-深入搜索-控制相关度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-11 09:52:57" itemprop="dateCreated datePublished" datetime="2020-03-11T09:52:57+08:00">2020-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 16:57:14" itemprop="dateModified" datetime="2020-05-26T16:57:14+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a></p>
<h3 id="控制相关度简介"><a href="#控制相关度简介" class="headerlink" title="控制相关度简介"></a>控制相关度简介</h3><p>全文相关的公式或 相似算法（similarity algorithms） 会将多个因素合并起来，为每个文档生成一个相关度评分 <code>_score</code>。</p>
<p>当然，相关度不只与全文查询有关，也需要将结构化的数据考虑其中。</p>
<h3 id="相关度评分背后的理论-Theory-Behind-Relevance-Scoring"><a href="#相关度评分背后的理论-Theory-Behind-Relevance-Scoring" class="headerlink" title="相关度评分背后的理论(Theory Behind Relevance Scoring)"></a>相关度评分背后的理论(Theory Behind Relevance Scoring)</h3><ol>
<li>使用<a href="http://en.wikipedia.org/wiki/Standard_Boolean_model" target="_blank" rel="noopener">布尔模型(Boolean model)</a>查询文档</li>
<li>用<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/practical-scoring-function.html" target="_blank" rel="noopener">实用评分函数(practical scoring function)</a>的公式计算相关度。</li>
</ol>
<p>实用评分函数：</p>
<ol>
<li>借鉴 <a href="http://en.wikipedia.org/wiki/Tfidf" target="_blank" rel="noopener">词频/逆向文档频率（term frequency/inverse document frequency）</a> 和 <a href="http://en.wikipedia.org/wiki/Vector_space_model" target="_blank" rel="noopener">向量空间模型（vector space model)</a></li>
<li>现代新特性1: 协调因子（coordination factor）</li>
<li>现代新特性2: 字段长度归一化（field length normalization）</li>
<li>词或查询语句权重提升</li>
</ol>
<h5 id="词频-逆向文档频率-TF-IDF"><a href="#词频-逆向文档频率-TF-IDF" class="headerlink" title="词频/逆向文档频率(TF/IDF)"></a>词频/逆向文档频率(TF/IDF)</h5><p>一个文档的相关度部分取决于每个查询词在文档中的权重。<br>词权重由三个因素决定：词频(TF),反向文档频率(IDF),字段长度</p>
<h5 id="词频-Term-frequency"><a href="#词频-Term-frequency" class="headerlink" title="词频(Term frequency)"></a>词频(Term frequency)</h5><ul>
<li>词频:词在文档中出现的频度,频道越高，权重越高。</li>
<li>禁止使用词频，配置index_options为docs，</li>
<li>禁止词频后索引不会记录词频和词频位置，短语和近似查询也不可用</li>
<li>禁用词频配置：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"text"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>:          <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"index_options"</span>: <span class="string">"docs"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="反向文档频率-Inverse-document-frequency"><a href="#反向文档频率-Inverse-document-frequency" class="headerlink" title="反向文档频率(Inverse document frequency)"></a>反向文档频率(Inverse document frequency)</h5><ul>
<li>反向文档频率： 包含词的文档在文档集合中出现的频率，频次越高，权重越低。</li>
<li>公式：idf(t) = 1 + log ( numDocs / (docFreq + 1))，<ul>
<li>idf(t) : 词t的逆向文档频率</li>
<li>numDocs ：索引中的文档数</li>
<li>docFreq ：包含词的文档数</li>
</ul>
</li>
</ul>
<h5 id="字段长度归一值-Field-length-norm"><a href="#字段长度归一值-Field-length-norm" class="headerlink" title="字段长度归一值 (Field-length norm)"></a>字段长度归一值 (Field-length norm)</h5><ul>
<li>字段(field)的长度是多少？字段越短，字段的权重 越高 。</li>
<li>字段长度的归一值对全文搜索非常重要</li>
<li>字段长度的归一值，索引中每个文档的每个 string 字段都大约占用 1 个 byte 的空间。</li>
<li>not_analyzed(keyword)字段归一值默认是禁用的，analyzed也可以修改映射禁止归一值</li>
<li>日志的应用场景只关心是否包含错误码或其他唯一标识，不关心字段长度，禁用归一值可以节省大量内存空间。</li>
</ul>
<p>公式(平方根的倒数)：<br>norm(d) = 1 / √numTerms</p>
<p>修改映射禁止归一值</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"text"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"norms"</span>: &#123; <span class="attr">"enabled"</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="结合使用"><a href="#结合使用" class="headerlink" title="结合使用"></a>结合使用</h5><p>以下三个因素：词频、逆向文档频率和字段长度归一值（field-length norm），词频和字段长度归一值在索引时计算并存储的。查询时把他们结合在一起计算单个词在特定文档中的 权重。</p>
<p>查看相关度评分因子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/doc/_search?explain</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"fox"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="向量空间模型-vector-space-model"><a href="#向量空间模型-vector-space-model" class="headerlink" title="向量空间模型(vector space model)"></a>向量空间模型(vector space model)</h5><ul>
<li>向量空间模型(vector space model)提供了一种比较多词查询的方式，单个评分代表文档与查询的匹配程度。</li>
<li>向量值：每个词在查询语句中权重值</li>
<li>两类向量是：1. 全部查询词组成的一个向量 2. 每个匹配文档组成一个向量，包含的词在向量中为权重值，没包含的词在向量中为0。</li>
</ul>
<p>例如：<br>查询语句： “happy hippopotamus”,happy权重为2，hippopotamus权重为5。<br>文档如下：</p>
<ol>
<li>I am happy in summer 。</li>
<li>After Christmas I’m a hippopotamus 。</li>
<li>The happy hippopotamus helped Harry 。</li>
</ol>
<p>向量如下：<br>查询向量: happy hippopotamus — (2,5) – query[2,5]<br>文档1：(happy,             ) — (2,0) – doc1 [2,0]<br>文档2：(     , hippopotamus) — (0,5) – doc2 [0,5]<br>文档1：(happy, hippopotamus) — (2,5) – doc3 [2,5]</p>
<p>把4个向量都放入坐标系中，以(0,0)为起点做直线，计算doc1,doc2,doc3与query之间的夹角就可以得出相关度。夹角越小，相关度越高，夹角越大，相关度越低。</p>
<p>关于比较两个向量的更多信息可以参考 : <a href="http://en.wikipedia.org/wiki/Cosine_similarity" target="_blank" rel="noopener">余弦近似度（cosine similarity）</a>。</p>
<h3 id="Lucene-的实用评分函数"><a href="#Lucene-的实用评分函数" class="headerlink" title="Lucene 的实用评分函数"></a>Lucene 的实用评分函数</h3><p>对于多词查询， Lucene 使用 布尔模型（Boolean model） 、 TF/IDF 以及 向量空间模型（vector space model） ，然后将它们组合到单个高效的包里以收集匹配文档并进行评分计算。</p>
<p>一个多词查询最终转换为bool模型</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"quick fox"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123;<span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">        &#123;<span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"fox"</span>   &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实用评分函数（practical-scoring-function）"><a href="#实用评分函数（practical-scoring-function）" class="headerlink" title="实用评分函数（practical scoring function）"></a>实用评分函数（practical scoring function）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">score(q,d)  &#x3D;                &#x2F;&#x2F; score(q,d) 是文档 d 与查询 q 的相关度评分。</span><br><span class="line">            queryNorm(q)     &#x2F;&#x2F; queryNorm(q) 是 查询归一化 因子。</span><br><span class="line">          · coord(q,d)       &#x2F;&#x2F; coord(q,d) 是 协调 因子。</span><br><span class="line">          · ∑ (              &#x2F;&#x2F; 查询 q 中每个词 t 对于文档 d 的权重和。</span><br><span class="line">                tf(t in d)   &#x2F;&#x2F; tf(t in d) 是词 t 在文档 d 中的 词频 。</span><br><span class="line">              · idf(t)²      &#x2F;&#x2F; idf(t) 是词 t 的 逆向文档频率 。</span><br><span class="line">              · t.getBoost() &#x2F;&#x2F; t.getBoost() 是查询中使用的 boost。</span><br><span class="line">              · norm(t,d)    &#x2F;&#x2F; norm(t,d)是字段长度归一值与索引时字段层boost（如果存在）的和。</span><br><span class="line">            ) (t in q)</span><br></pre></td></tr></table></figure>

<h5 id="查询归一因子-Query-Normalization-Factor"><a href="#查询归一因子-Query-Normalization-Factor" class="headerlink" title="查询归一因子(Query Normalization Factor)"></a>查询归一因子(Query Normalization Factor)</h5><p>查询归一因子(queryNorm)试图将查询归一化，这样两个不同的结果可以比较。</p>
<blockquote>
<p>尽管查询归一值的目的是为了使查询结果之间能够相互比较，但是它并不十分有效，因为相关度评分<br><code>_score</code> 的目的是为了将当前查询的结果进行排序，比较不同查询结果的相关度评分没有太大意义。</p>
</blockquote>
<blockquote>
<p>相同查询归一化因子会被应用到每个文档，不能被更改，总而言之，可以被忽略。</p>
</blockquote>
<h5 id="查询协调-Query-Coordination"><a href="#查询协调-Query-Coordination" class="headerlink" title="查询协调 (Query Coordination)"></a>查询协调 (Query Coordination)</h5><ul>
<li>协调因子(coord)可以为查询词包含度高的文档提供奖励，扩大化分值差距，使匹配度高的成为更好的匹配结果。</li>
<li>bool查询中should语句 默认会使用协调功能。</li>
<li>协调因子使用场景：bool查询中有多个match查询时，希望匹配越多排序越靠前。</li>
<li>协调因子禁用场景：不关心匹配多个查询词，例如：查找的是同义词时不关心文档中出现多少个同义词。</li>
<li>当使用同义词时Lucene会重写的查询会禁用同义词的协调功能。大多数禁用操作的应用场景是自动处理的，无须为此担心。</li>
</ul>
<p>添加协调因子例如：<br>| Header One              | 原评分 | 加协调因子       |<br>| :————-          | :—- | :—-           |<br>| 文档里有 fox             | 1.5 | 1.5 * 1 / 3 = 0.5 |<br>| 文档里有 quick fox       | 3.0 |3.0 * 2 / 3 = 2.0  |<br>| 文档里有 quick brown fox | 4.5 |4.5 * 3 / 3 = 4.5  |</p>
<p>禁用协调因子</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"disable_coord"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"jump"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"hop"</span>  &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"leap"</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="索引时字段层权重提升-Index-Time-Field-Level-Boosting"><a href="#索引时字段层权重提升-Index-Time-Field-Level-Boosting" class="headerlink" title="索引时字段层权重提升(Index-Time Field-Level Boosting)"></a>索引时字段层权重提升(Index-Time Field-Level Boosting)</h5><p>字段权重提升就是让某个字段比其他字段更重要,权重的提升会被应用到字段的每个词，而不是字段本身.</p>
<p>不建议在建立索引时对字段提升权重,原因如下：</p>
<ul>
<li>归一值精度丢失。将提升值与字段长度归一值合在单个字节中存储会丢失字段长度归一值的精度，这样会导致 Elasticsearch 不知如何区分包含三个词的字段和包含五个词的字段。</li>
<li>索引时提升值需要重构索引。要想改变索引时的提升值，就必须重新为所有文档建立索引，与此不同的是，查询时的提升值可以随着每次查询的不同而更改。</li>
<li>会导致权重急剧上升。如果一个索引时权重提升的字段有多个值，提升值会按照每个值来自乘，这会导致该字段的权重急剧上升。</li>
</ul>
<h3 id="查询时权重提升-Query-Time-Boosting"><a href="#查询时权重提升-Query-Time-Boosting" class="headerlink" title="查询时权重提升(Query-Time Boosting)"></a>查询时权重提升(Query-Time Boosting)</h3><ul>
<li>使用boost参数让一个查询语句比其他语句更重要。</li>
<li>boost默认值为 1。</li>
<li>boost 设置为 2 ，并不代表最终的评分 <code>_score</code> 是原值的两倍，因为权重值会经过归一化和一些其他内部优化过程。</li>
<li>无法通过简单公式得出某个权重提升值，只能不断尝试。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">"should": [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: &#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"quick brown fox"</span>,</span><br><span class="line">        <span class="attr">"boost"</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>: <span class="string">"quick brown fox"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h5 id="提升索引权重-Boosting-an-Index"><a href="#提升索引权重-Boosting-an-Index" class="headerlink" title="提升索引权重(Boosting an Index)"></a>提升索引权重(Boosting an Index)</h5><ul>
<li>在多个索引中搜索时，可以使用参数indices_boost来提升索引的权重。</li>
<li>没配置时默认值为 1</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /docs_2014_*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"indices_boost"</span>: &#123;</span><br><span class="line">    <span class="attr">"docs_2014_10"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"docs_2014_09"</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"quick brown fox"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="t-getBoost"><a href="#t-getBoost" class="headerlink" title="t.getBoost()"></a>t.getBoost()</h5><ul>
<li>在Lucene中通过t.getBoost()获得实用评分函数的提升权限。</li>
<li>权重提升不会被应用于它在查询表达式中出现的层，而是会被合并下转至每个词中。</li>
<li>t.getBoost() 始终返回当前词的权重或当前分析链上查询的权重。</li>
<li>explain中无法看boost值，因为权重值融入到queryNorm中并应用到每个词</li>
</ul>
<h3 id="使用查询结构修改相关度-Manipulating-Relevance-with-Query-Structure"><a href="#使用查询结构修改相关度-Manipulating-Relevance-with-Query-Structure" class="headerlink" title="使用查询结构修改相关度(Manipulating Relevance with Query Structure)"></a>使用查询结构修改相关度(Manipulating Relevance with Query Structure)</h3><p>通过调整查询语句的层次，可以改变其主要性。<br><code>quick OR brown OR red OR fox</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"brown"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"red"</span>   &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"fox"</span>   &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>quick OR (brown OR red) OR fox</code><br>red 和 brown 处于相互竞争的层次， quick 、 fox 以及 red OR brown 则是处于顶层且相互竞争的词.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"fox"</span>   &#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"bool"</span>: &#123;</span><br><span class="line">            <span class="attr">"should"</span>: [</span><br><span class="line">              &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"brown"</span> &#125;&#125;,</span><br><span class="line">              &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"red"</span>   &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Not-Quite-Not"><a href="#Not-Quite-Not" class="headerlink" title="Not Quite Not"></a>Not Quite Not</h3><ul>
<li>将某些查询语句的权重降低而不是排除。</li>
<li>boost查询中 positive(正向提升) 和 negative(负向降低) 查询。</li>
<li>negative_boost的值必须小于 1.0。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"apple"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"must_not"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"pie tart fruit crumble tree"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>boost查询的positive和</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"boosting"</span>: &#123;</span><br><span class="line">      <span class="attr">"positive"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"apple"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"pie tart fruit crumble tree"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative_boost"</span>: <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="忽略-TF-IDF"><a href="#忽略-TF-IDF" class="headerlink" title="忽略 TF/IDF"></a>忽略 TF/IDF</h3><ul>
<li>如果只关心一个词是否在某个字段中出现过，那就忽略TF/IDF</li>
<li>查询语句中使用constant_score忽略TF/IDF</li>
<li>not_analyzed(keyword)字段每个词的IDF会使用，会禁用字段长度归一值（field-length norms)和禁用词频(index_options: docs)，</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>: &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"description"</span>: <span class="string">"wifi"</span> &#125;&#125;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>: &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"description"</span>: <span class="string">"garden"</span> &#125;&#125;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">          <span class="attr">"boost"</span>:   <span class="number">2</span>,</span><br><span class="line">          <span class="attr">"query"</span>: &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"description"</span>: <span class="string">"pool"</span> &#125;&#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="function-score-查询"><a href="#function-score-查询" class="headerlink" title="function_score 查询"></a>function_score 查询</h3><p>过滤器无法计算评分。这样就需要寻求一种方式将过滤器和查询间的差异抹平。<br>function_score 查询不仅正好可以扮演这个角色，而且有更强大的功能。</p>
<p>###</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.fwbo.me/2020/03/10/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/17-%E6%B7%B1%E5%85%A5%E6%90%9C%E7%B4%A2-%E9%83%A8%E5%88%86%E5%8C%B9%E9%85%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
      <meta itemprop="name" content="fandro">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="细数星辰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/10/ELK%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/17-%E6%B7%B1%E5%85%A5%E6%90%9C%E7%B4%A2-%E9%83%A8%E5%88%86%E5%8C%B9%E9%85%8D/" class="post-title-link" itemprop="url">17-深入搜索-部分匹配(Partial_Matching)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-10 20:52:57" itemprop="dateCreated datePublished" datetime="2020-03-10T20:52:57+08:00">2020-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-26 13:53:30" itemprop="dateModified" datetime="2020-05-26T13:53:30+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="">中文参考</a>，<a href="">英文参考</a></p>
<h3 id="部分匹配"><a href="#部分匹配" class="headerlink" title="部分匹配"></a>部分匹配</h3><p>前面介绍的都是整个词的匹配，最小单元为单个词。<br>部分匹配(Partial matching)：</p>
<blockquote>
<p>允许查询词的一部分并返回包含这部分片断的词。</p>
</blockquote>
<p>部分匹配的应用场景：</p>
<ul>
<li>某个特定前缀开始，例如 邮编，产品序列或未分析值</li>
<li>某种模式匹配，例如 邮编，产品序列或未分析值</li>
<li>与某个正则式相匹配，例如 邮编，产品序列或未分析值</li>
<li>输入即搜索(search-as-you-type) : 用户搜索时呈现可能的结果</li>
<li>匹配如德语或荷兰语这样有长组合词的语言，如： Weltgesundheitsorganisation （世界卫生组织，英文 World Health Organization）。</li>
</ul>
<h3 id="邮编与结构化数据"><a href="#邮编与结构化数据" class="headerlink" title="邮编与结构化数据"></a>邮编与结构化数据</h3><p>邮编是有规律的结构化数据，需要配置成not_analyzed(keyword).<br>初始化邮编数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/address/1</span><br><span class="line">&#123; <span class="attr">"postcode"</span>: <span class="string">"W1V 3DG"</span> &#125;</span><br><span class="line">PUT /my_index/address/2</span><br><span class="line">&#123; <span class="attr">"postcode"</span>: <span class="string">"W2F 8HW"</span> &#125;</span><br><span class="line">PUT /my_index/address/3</span><br><span class="line">&#123; <span class="attr">"postcode"</span>: <span class="string">"W1F 7HW"</span> &#125;</span><br><span class="line">PUT /my_index/address/4</span><br><span class="line">&#123; <span class="attr">"postcode"</span>: <span class="string">"WC1N 1LZ"</span> &#125;</span><br><span class="line">PUT /my_index/address/5</span><br><span class="line">&#123; <span class="attr">"postcode"</span>: <span class="string">"SW5 0BE"</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="prefix-前缀查询"><a href="#prefix-前缀查询" class="headerlink" title="prefix 前缀查询"></a>prefix 前缀查询</h3><p>前缀查询</p>
<ul>
<li>前缀查询是一个词级别的底层查询</li>
<li>不会对前缀进行分词</li>
<li>前缀查询不做相关度评分计算，结果评分都是1.</li>
<li>前缀查询和前缀过滤器唯一区别就是过滤器可以被缓存</li>
<li>前缀查询过程是依次匹配倒排索引的词列表中词。</li>
<li>注意事项：字段中词的集合要小，前缀长度不要太短，否则会有性能问题</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"prefix"</span>: &#123;</span><br><span class="line">            <span class="attr">"postcode"</span>: <span class="string">"W1"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通配符与正则表达式查询-wildcard-and-regexp-Queries"><a href="#通配符与正则表达式查询-wildcard-and-regexp-Queries" class="headerlink" title="通配符与正则表达式查询 (wildcard and regexp Queries)"></a>通配符与正则表达式查询 (wildcard and regexp Queries)</h3><p>通配符(wildcard)和正则式</p>
<ul>
<li>通配符是一种底层基于词的查询</li>
<li>允许指定匹配的正则表达式</li>
<li>通配符使用shell通配符：？匹配任意字符，<code>*</code> 匹配 0或多个字符</li>
<li>regexp 可以定义复杂的匹配模式</li>
<li>wildcard 和 regexp 查询的工作方式与 prefix 查询完全一样，需要扫描倒排索引中的词列表才能找到所有匹配的词，然后依次获取每个词相关的文档 ID</li>
<li>wildcard 和 regexp 查询同样也存在性能问题，应该避免使用左通配的匹配(如:<code>*foo</code>)</li>
<li>prefix 、 wildcard 和 regexp 查询虽然有使用场景，但仍需谨慎使用。</li>
</ul>
<p>通配符</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"wildcard"</span>: &#123;</span><br><span class="line">            <span class="attr">"postcode"</span>: <span class="string">"W?F*HW"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正则表达式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"regexp"</span>: &#123;</span><br><span class="line">            <span class="attr">"postcode"</span>: <span class="string">"W[0-9].+"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>prefix 、 wildcard 和 regexp 查询是基于词操作的</code><br>正常查询返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">"regexp"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"br.*"</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>以下查询不是基于词操作，无法返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">"regexp"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Qu.*"</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"regexp"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"quick br*"</span> &#125;&#125;</span><br></pre></td></tr></table></figure>


<h3 id="查询时输入即搜索-Index-Time-Optimizations"><a href="#查询时输入即搜索-Index-Time-Optimizations" class="headerlink" title="查询时输入即搜索(Index-Time Optimizations)"></a>查询时输入即搜索(Index-Time Optimizations)</h3><p>即时搜索（instant search）或 输入即搜索（search-as-you-type）: 用户未输入完内容之前就能展现结果。<br>通过<code>match_phrase_prefix</code>实现即时搜索的功能.</p>
<p>match_phrase_prefix</p>
<ul>
<li>与match_phrase类似，唯一不同的是最后一个词作为前缀使用。</li>
<li>match_phrase_prefix也可以接受slop参数</li>
<li>match_phrase_prefix也存在严重的资源消耗问题</li>
<li>通过max_expansions参数来限制匹配数量，合理值是50, 匹配倒排索引词列表的前N个词项。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"match_phrase_prefix"</span> : &#123;</span><br><span class="line">        <span class="attr">"brand"</span> : &#123;</span><br><span class="line">            <span class="attr">"query"</span>: <span class="string">"walker johnnie bl"</span>,</span><br><span class="line">            <span class="attr">"max_expansions"</span>: <span class="number">50</span>,</span><br><span class="line">            <span class="attr">"slop"</span>:  <span class="number">10</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引时优化"><a href="#索引时优化" class="headerlink" title="索引时优化"></a>索引时优化</h3><p>查询时解决方案都是以牺牲搜索性能为代价的。<br>索引时优化数据可以提供搜索的灵活性，提升系统性能。<br>索引优化的代价是：1. 增加索引空间 2.索引能力变慢</p>
<h3 id="Ngrams-在部分匹配的应用"><a href="#Ngrams-在部分匹配的应用" class="headerlink" title="Ngrams 在部分匹配的应用"></a>Ngrams 在部分匹配的应用</h3><p>‘profix,wildcard,regexp’的方案是:</p>
<blockquote>
<p>搜索内容与词的各个字母比较匹配。</p>
</blockquote>
<p>N-Grams 方案是:</p>
<blockquote>
<p>把词项拆分成各种组合列表，然后索引起来，搜索时只需要像term一样查询，只进行词相等比较。</p>
</blockquote>
<p>n-grams 形式如下：</p>
<ul>
<li>长度 1（unigram）： [ q, u, i, c, k ]</li>
<li>长度 2（bigram）： [ qu, ui, ic, ck ]</li>
<li>长度 3（trigram）： [ qui, uic, ick ]</li>
<li>长度 4（four-gram）： [ quic, uick ]</li>
<li>长度 5（five-gram）： [ quick ]</li>
</ul>
<p>edge n-grams(边界n-grams)形式如下：</p>
<ul>
<li>q</li>
<li>qu</li>
<li>qui</li>
<li>quic</li>
<li>quick</li>
</ul>
<p>edge n-grams能满足输入即搜索（search-as-you-type）这种应用场景。</p>
<h3 id="索引时输入即搜索-Index-Time-Search-as-You-Type"><a href="#索引时输入即搜索-Index-Time-Search-as-You-Type" class="headerlink" title="索引时输入即搜索(Index-Time Search-as-You-Type)"></a>索引时输入即搜索(Index-Time Search-as-You-Type)</h3><p>配置边界ngram(edge ngram):</p>
<ol>
<li>在analysis.filter中配置过滤器autocomplete_filter</li>
<li>在analysis.analyzer中配置分析器autocomplete，并在起filter中添加autocomplete_filter</li>
<li>在映射中给属性配置上自定义分析器autocomplete</li>
<li>搜索时索引分析器(index_search)和搜索分析器(search_index)需要指定不同的分析器，两种方法：<ol>
<li>在搜索语句中指定搜索分析器。</li>
<li>映射mapping配置时，索引和搜索分析器配置不同的分析器。</li>
</ol>
</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;</span><br><span class="line">        <span class="attr">"number_of_shards"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">            <span class="attr">"filter"</span>: &#123;</span><br><span class="line">                <span class="attr">"autocomplete_filter"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>:     <span class="string">"edge_ngram"</span>,</span><br><span class="line">                    <span class="attr">"min_gram"</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="attr">"max_gram"</span>: <span class="number">20</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">                <span class="attr">"autocomplete"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>:      <span class="string">"custom"</span>,</span><br><span class="line">                    <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">                    <span class="attr">"filter"</span>: [</span><br><span class="line">                        <span class="string">"lowercase"</span>,</span><br><span class="line">                        <span class="string">"autocomplete_filter"</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一种方法：在搜索语句中指定搜索分析器,不使用分析器autocomplete。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: &#123;</span><br><span class="line">                <span class="attr">"query"</span>:    <span class="string">"brown fo"</span>,</span><br><span class="line">                <span class="attr">"analyzer"</span>: <span class="string">"standard"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"name"</span>: &#123;</span><br><span class="line">              <span class="attr">"query"</span>:    <span class="string">"brown fo"</span>,</span><br><span class="line">              <span class="attr">"analyzer"</span>: <span class="string">"standard"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种方法：映射mapping配置时，索引和搜索分析器配置不同的分析器。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/my_type/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"my_type"</span>: &#123;</span><br><span class="line">        <span class="attr">"properties"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: &#123;</span><br><span class="line">                <span class="attr">"type"</span>:            <span class="string">"string"</span>,</span><br><span class="line">                <span class="attr">"index_analyzer"</span>:  <span class="string">"autocomplete"</span>,</span><br><span class="line">                <span class="attr">"search_analyzer"</span>: <span class="string">"standard"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ngrams比match_phrase_prefix方式要高效的多，但n-grams有时会有延迟问，索引ES又创建了 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-suggesters-completion.html" target="_blank" rel="noopener">completion suggester</a></p>
<p>completion suggester:</p>
<blockquote>
<p>Elasticsearch 里的 completion suggester 采用与上面完全不同的方式，需要为搜索条件生成一个所有可能完成的词列表，然后将它们置入一个 有限状态机（finite state transducer） 内，这是个经优化的图结构。为了搜索建议提示，Elasticsearch 从图的开始处顺着匹配路径一个字符一个字符地进行匹配，一旦它处于用户输入的末尾，Elasticsearch 就会查找所有可能结束的当前路径，然后生成一个建议列表。<br>本数据结构存于内存中，能使前缀查找非常快，比任何一种基于词的查询都要快很多，这对名字或品牌的自动补全非常适用，因为这些词通常是以普通顺序组织的：用 “Johnny Rotten” 而不是 “Rotten Johnny” 。<br>当词序不是那么容易被预见时，边界 n-grams 比完成建议者（Completion Suggester）更合适。即使说不是所有猫都是一个花色，那这只猫的花色也是相当特殊的。</p>
</blockquote>
<h5 id="边界-n-grams-与邮编"><a href="#边界-n-grams-与邮编" class="headerlink" title="边界 n-grams 与邮编"></a>边界 n-grams 与邮编</h5><p>edge n-gram也可以用于结构化数据。使用keyword分词器来处理。</p>
<blockquote>
<p>keyword 分词器是一个非操作型分词器，这个分词器不做任何事情，它接收的任何字符串都会被原样发出，因此它可以用来处理 not_analyzed 的字段值，但这也需要其他的一些分析转换，如将字母转换成小写。</p>
</blockquote>
<p>下面示例使用 keyword 分词器将邮编转换成 token 流，这样就能使用边界 n-gram token 过滤器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">        <span class="attr">"filter"</span>: &#123;</span><br><span class="line">            <span class="attr">"postcode_filter"</span>: &#123;</span><br><span class="line">                <span class="attr">"type"</span>:     <span class="string">"edge_ngram"</span>,</span><br><span class="line">                <span class="attr">"min_gram"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"max_gram"</span>: <span class="number">8</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">            <span class="attr">"postcode_index"</span>: &#123;</span><br><span class="line">                <span class="attr">"tokenizer"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"filter"</span>:    [ <span class="string">"postcode_filter"</span> ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"postcode_search"</span>: &#123;</span><br><span class="line">                <span class="attr">"tokenizer"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>postcode_index 分析器使用 postcode_filter 将邮编转换成边界 n-gram 形式。</li>
<li>postcode_search 分析器可以将搜索词看成 not_analyzed 未分析的。</li>
</ul>
<h3 id="Ngrams-在复合词的应用-Ngrams-for-Compound-Words"><a href="#Ngrams-在复合词的应用-Ngrams-for-Compound-Words" class="headerlink" title="Ngrams 在复合词的应用 (Ngrams for Compound Words)"></a>Ngrams 在复合词的应用 (Ngrams for Compound Words)</h3><p>两种方法：</p>
<ol>
<li>用 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/analysis-compound-word-tokenfilter.html" target="_blank" rel="noopener">组合词 token 过滤器（compound word token filter）</a>将复合词拆分成各自部分，但这种方式的结果质量依赖于组合词字典的质量。</li>
<li>所有的词用 n-gram 进行处理，然后搜索任何匹配的片段——能匹配的片段越多，文档的相关度越大。再结合参数minimum_should_match和shingle使用。</li>
</ol>
<p>n-grams配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;</span><br><span class="line">        <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">            <span class="attr">"filter"</span>: &#123;</span><br><span class="line">                <span class="attr">"trigrams_filter"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>:     <span class="string">"ngram"</span>,</span><br><span class="line">                    <span class="attr">"min_gram"</span>: <span class="number">3</span>,</span><br><span class="line">                    <span class="attr">"max_gram"</span>: <span class="number">3</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">                <span class="attr">"trigrams"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>:      <span class="string">"custom"</span>,</span><br><span class="line">                    <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">                    <span class="attr">"filter"</span>:   [</span><br><span class="line">                        <span class="string">"lowercase"</span>,</span><br><span class="line">                        <span class="string">"trigrams_filter"</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_type"</span>: &#123;</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"text"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>:     <span class="string">"string"</span>,</span><br><span class="line">                    <span class="attr">"analyzer"</span>: <span class="string">"trigrams"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze?analyzer=trigrams</span><br><span class="line">Weißkopfseeadler</span><br></pre></td></tr></table></figure>
<p>搜索语句：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"text"</span>: &#123;</span><br><span class="line">                <span class="attr">"query"</span>:                <span class="string">"Gesundheit"</span>,</span><br><span class="line">                <span class="attr">"minimum_should_match"</span>: <span class="string">"80%"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>
<p>###</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fandro"
      src="http://qax2cai8x.bkt.clouddn.com/header.jpeg">
  <p class="site-author-name" itemprop="name">fandro</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fandro</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">198k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">3:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
